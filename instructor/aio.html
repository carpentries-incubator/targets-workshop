<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>Introduction to targets: All in One View</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="../assets/styles.css">
<script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="manifest" href="../site.webmanifest">
<link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
</head>
<body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
<li><button class="dropdown-item" type="button" onclick="window.location.href='../aio.html';">Learner View</button></li>
        </ul>
</div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg">
</div>
    <div class="lesson-title-md">
      Introduction to targets
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
<li class="nav-item">
          <span class="lesson-title">
            Introduction to targets
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul>
</li>
      </ul>
</div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled>
<input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset>
</form>
  </div>
<!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to targets
</div>

<aside class="col-md-12 lesson-progress"><div style="width: %" class="percentage">
    %
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: %" aria-valuenow="" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../aio.html">Learner View</a>
                      </div>
                    </div>
                  </div>
<!--/div.accordion-item-->
                </div>
<!--/div.accordion-flush-->
              </div>
<!--div.sidenav-view-selector -->
            </div>
<!--/div.col -->
      
            <hr>
</div>
<!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Introduction</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="basic-targets.html">2. First targets Workflow</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="cache.html">3. Loading Workflow Objects</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="lifecycle.html">4. The Workflow Lifecycle</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="organization.html">5. Best Practices for targets Project Organization</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="packages.html">6. Managing Packages</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="files.html">7. Working with External Files</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush9">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading9">
        <a href="branch.html">8. Branching</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="parallel.html">9. Parallel Processing</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="quarto.html">10. Reproducible Reports with Quarto</a>
    </div>
<!--/div.accordion-header-->
        
  </div>
<!--/div.accordion-item-->
</div>
<!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width">
<div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul>
<li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      
                    </ul>
</div>
                </div>
              </div>
            </div>
            <hr class="half-width resources">
<a href="../instructor/aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none">
<div class="d-grid gap-1">
            
            </div>
          </div>
<!-- /div.accordion -->
        </div>
<!-- /div.sidebar-inner -->
      </nav>
</div>
<!-- /div.sidebar -->
  </div>
<!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-extra.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <main id="main-content" class="main-content"><div class="container lesson-content">
        
        
<section id="aio-introduction"><p>Content from <a href="introduction.html">Introduction</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/introduction.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Why should we care about reproducibility?</li>
<li>How can <code>targets</code> help us achieve reproducibility?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain why reproducibility is important for science</li>
<li>Describe the features of <code>targets</code> that enhance
reproducibility</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>Episode summary: Introduce the idea of reproducibility and why / who
would want to use <code>targets</code></p>
</div>
</div>
</div>
</div>
<section id="what-is-reproducibility"><h2 class="section-heading">What is reproducibility?<a class="anchor" aria-label="anchor" href="#what-is-reproducibility"></a>
</h2>
<hr class="half-width">
<p>Reproducibility is the ability for others (including your future
self) to reproduce your analysis.</p>
<p>We can only have confidence in the results of scientific analyses if
they can be reproduced.</p>
<p>However, reproducibility is not a binary concept (not reproducible
vs. reproducible); rather, there is a scale from <strong>less</strong>
reproducible to <strong>more</strong> reproducible.</p>
<p><code>targets</code> goes a long ways towards making your analyses
<strong>more reproducible</strong>.</p>
<p>Other practices you can use to further enhance reproducibility
include controlling your computing environment with tools like Docker,
conda, or renv, but we don’t have time to cover those in this
workshop.</p>
</section><section id="what-is-targets"><h2 class="section-heading">What is <code>targets</code>?<a class="anchor" aria-label="anchor" href="#what-is-targets"></a>
</h2>
<hr class="half-width">
<p><code>targets</code> is a workflow management package for the R
programming language developed and maintained by Will Landau.</p>
<p>The major features of <code>targets</code> include:</p>
<ul>
<li>
<strong>Automation</strong> of workflow</li>
<li>
<strong>Caching</strong> of workflow steps</li>
<li>
<strong>Batch creation</strong> of workflow steps</li>
<li>
<strong>Parallelization</strong> at the level of the workflow</li>
</ul>
<p>This allows you to do the following:</p>
<ul>
<li>return to a project after working on something else and immediately
pick up where you left off without confusion or trying to remember what
you were doing</li>
<li>change the workflow, then only re-run the parts that that are
affected by the change</li>
<li>massively scale up the workflow without changing individual
functions</li>
</ul>
<p>… and of course, it will help others reproduce your analysis.</p>
</section><section id="who-should-use-targets"><h2 class="section-heading">Who should use <code>targets</code>?<a class="anchor" aria-label="anchor" href="#who-should-use-targets"></a>
</h2>
<hr class="half-width">
<p><code>targets</code> is by no means the only workflow management
software. There is a large number of similar tools, each with varying
features and use-cases. For example, <a href="https://snakemake.readthedocs.io/en/stable/" class="external-link">snakemake</a> is a
popular workflow tool for python, and <a href="https://www.gnu.org/software/make/" class="external-link"><code>make</code></a> is a
tool that has been around for a very long time for automating bash
scripts. <code>targets</code> is designed to work specifically with R,
so it makes the most sense to use it if you primarily use R, or intend
to. If you mostly code with other tools, you may want to consider an
alternative.</p>
<p>The <strong>goal</strong> of this workshop is to <strong>learn how to
use <code>targets</code> to reproducible data analysis in
R</strong>.</p>
</section><section id="where-to-get-more-information"><h2 class="section-heading">Where to get more information<a class="anchor" aria-label="anchor" href="#where-to-get-more-information"></a>
</h2>
<hr class="half-width">
<p><code>targets</code> is a sophisticated package and there is a lot
more to learn that we can cover in this workshop.</p>
<p>Here are some recommended resources for continuing on your
<code>targets</code> journey:</p>
<ul>
<li>
<a href="https://books.ropensci.org/targets/" class="external-link">The
<code>targets</code> R package user manual</a> by the author of
<code>targets</code>, Will Landau, should be considered required reading
for anyone seriously interested in <code>targets</code>.</li>
<li>
<a href="https://github.com/ropensci/targets/discussions" class="external-link">The
<code>targets</code> discussion board</a> is a great place for asking
questions and getting help. Before you ask a question though, be sure to
<a href="https://books.ropensci.org/targets/help.html" class="external-link">read the policy
on asking for help</a>.</li>
<li>
<a href="https://docs.ropensci.org/targets/" class="external-link">The
<code>targets</code> package webpage</a> includes documentation of all
<code>targets</code> functions.</li>
<li>
<a href="https://docs.ropensci.org/tarchetypes/" class="external-link">The
<code>tarchetypes</code> package webpage</a> includes documentation of
all <code>tarchetypes</code> functions. You will almost certainly use
<code>tarchetypes</code> along with <code>targets</code>, so it’s good
to consult both.</li>
<li>
<a href="https://github.com/wlandau/targets-tutorial" class="external-link">Reproducible
computation at scale in R with <code>targets</code></a> is a tutorial by
Will Landau analyzing customer churn with Keras.</li>
<li>
<a href="https://github.com/ropensci/targets#recorded-talks" class="external-link">Recorded
talks</a> and <a href="https://github.com/ropensci/targets#example-projects" class="external-link">example
projects</a> listed on the <code>targets</code> README.</li>
</ul></section><section id="about-the-example-dataset"><h2 class="section-heading">About the example dataset<a class="anchor" aria-label="anchor" href="#about-the-example-dataset"></a>
</h2>
<hr class="half-width">
<p>For this workshop, we will analyze an example dataset of measurements
taken on adult foraging Adélie, Chinstrap, and Gentoo penguins observed
on islands in the Palmer Archipelago, Antarctica.</p>
<p>The data are available from the <code>palmerpenguins</code> R
package. You can get more information about the data by running
<code>?palmerpenguins</code>.</p>
<figure><img src="https://allisonhorst.github.io/palmerpenguins/reference/figures/lter_penguins.png" alt="" class="figure mx-auto d-block"><figcaption>The three species of penguins in the
<code>palmerpenguins</code> dataset. Artwork by <span class="citation">@allison_horst</span>.</figcaption></figure><p>The goal of the analysis is to determine the relationship between
bill length and depth by using linear models.</p>
<p>We will gradually build up the analysis through this lesson, but you
can see the final version at <a href="https://github.com/joelnitta/penguins-targets" class="external-link uri">https://github.com/joelnitta/penguins-targets</a>.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>We can only have confidence in the results of scientific analyses if
they can be reproduced by others (including your future self)</li>
<li>
<code>targets</code> helps achieve reproducibility by automating
workflow</li>
<li>
<code>targets</code> is designed for use with the R programming
language</li>
<li>The example dataset for this workshop includes measurements taken on
penguins in Antarctica</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-basic-targets"><p>Content from <a href="basic-targets.html">First targets Workflow</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/basic-targets.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are best practices for organizing analyses?</li>
<li>What is a <code>_targets.R</code> file for?</li>
<li>What is the content of the <code>_targets.R</code> file?</li>
<li>How do you run a workflow?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Create a project in RStudio</li>
<li>Explain the purpose of the <code>_targets.R</code> file</li>
<li>Write a basic <code>_targets.R</code> file</li>
<li>Use a <code>_targets.R</code> file to run a workflow</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>Episode summary: First chance to get hands dirty by writing a very
simple workflow</p>
</div>
</div>
</div>
</div>
<section id="create-a-project"><h2 class="section-heading">Create a project<a class="anchor" aria-label="anchor" href="#create-a-project"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="about-projects">About projects<a class="anchor" aria-label="anchor" href="#about-projects"></a>
</h3>
<p><code>targets</code> uses the “project” concept for organizing
analyses: all of the files needed for a given project are put in a
single folder, the project folder. The project folder has additional
subfolders for organization, such as folders for data, code, and
results.</p>
<p>By using projects, it makes it straightforward to re-orient yourself
if you return to an analysis after time spent elsewhere. This wouldn’t
be a problem if we only ever work on one thing at a time until
completion, but that is almost never the case. It is hard to remember
what you were doing when you come back to a project after working on
something else (a phenomenon called “context switching”). By using a
standardized organization system, you will reduce confusion and lost
time… in other words, you are increasing reproducibility!</p>
<p>This workshop will use RStudio, since it also works well with the
project organization concept.</p>
</div>
<div class="section level3">
<h3 id="create-a-project-in-rstudio">Create a project in RStudio<a class="anchor" aria-label="anchor" href="#create-a-project-in-rstudio"></a>
</h3>
<p>Let’s start a new project using RStudio.</p>
<p>Click “File”, then select “New Project”.</p>
<p>This will open the New Project Wizard, a set of menus to help you set
up the project.</p>
<figure><img src="../fig/basic-rstudio-wizard.png" alt="Screenshot of RStudio New Project Wizard menu" class="figure mx-auto d-block"><figcaption>The New Project Wizard</figcaption></figure><p>In the Wizard, click the first option, “New Directory”, since we are
making a brand-new project from scratch. Click “New Project” in the next
menu. In “Directory name”, enter a name that helps you remember the
purpose of the project, such as “targets-demo” (follow best practices
for naming files and folders). Under “Create project as a subdirectory
of…”, click the “Browse” button to select a directory to put the
project. We recommend putting it on your Desktop so you can easily find
it.</p>
<p>You can leave “Create a git repository” and “Use renv with this
project” unchecked, but these are both excellent tools to improve
reproducibility, and you should consider learning them and using them in
the future, if you don’t already. They can be enabled at any later time,
so you don’t need to worry about trying to use them immediately.</p>
<p>Once you work through these steps, your RStudio session should look
like this:</p>
<figure><img src="../fig/basic-rstudio-project.png" alt="Screenshot of RStudio with a newly created project called 'targets-demo' open containing a single file, 'targets-demo.Rproj'" class="figure mx-auto d-block"><figcaption>Your newly created project</figcaption></figure><p>Our project now contains a single file, created by RStudio:
<code>targets-demo.Rproj</code>. You should not edit this file by hand.
Its purpose is to tell RStudio that this is a project folder and to
store some RStudio settings (if you use version-control software, it is
OK to commit this file). Also, you can open the project by double
clicking on the <code>.Rproj</code> file in your file explorer (try it
by quitting RStudio then navigating in your file browser to your
Desktop, opening the “targets-demo” folder, and double clicking
<code>targets-demo.Rproj</code>).</p>
<p>OK, now that our project is set up, we are ready to start using
<code>targets</code>!</p>
</div>
</section><section id="create-a-_targets.r-file"><h2 class="section-heading">Create a <code>_targets.R</code> file<a class="anchor" aria-label="anchor" href="#create-a-_targets.r-file"></a>
</h2>
<hr class="half-width">
<p>Every <code>targets</code> project must include a special file,
called <code>_targets.R</code> in the main project folder (the “project
root”). The <code>_targets.R</code> file includes the specification of
the workflow: directions for R to run your analysis, kind of like a
recipe. By using the <code>_targets.R</code> file, you won’t have to
remember to run specific scripts in a certain order. Instead, R will do
it for you (more reproducibility points)!</p>
<div class="section level3">
<h3 id="anatomy-of-a-_targets-r-file">Anatomy of a <code>_targets.R</code> file<a class="anchor" aria-label="anchor" href="#anatomy-of-a-_targets-r-file"></a>
</h3>
<p>We will now start to write a <code>_targets.R</code> file.
Fortunately, <code>targets</code> comes with a function to help us do
this.</p>
<p>In the R console, first load the <code>targets</code> package with
<code><a href="https://docs.ropensci.org/targets/" class="external-link">library(targets)</a></code>, then run the command
<code>tar_script()</code>.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="fu">tar_script</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<p>Nothing will happen in the console, but in the file viewer, you
should see a new file, <code>_targets.R</code> appear. Open it using the
File menu or by clicking on it.</p>
<p>We can see this default <code>_targets.R</code> file includes three
main parts:</p>
<ul>
<li>Loading packages with <code>library()</code>
</li>
<li>Defining a custom function with <code>function()</code>
</li>
<li>Defining a list with <code>list()</code>.</li>
</ul>
<p>The last part, the list, is the most important part of the
<code>_targets.R</code> file. It defines the steps in the workflow. The
<code>_targets.R</code> file must always end with this list.</p>
<p>Furthermore, each item in the list is a call of the
<code>tar_target()</code> function. The first argument of
<code>tar_target()</code> is name of the target to build, and the second
argument is the command used to build it. Note that the name of the
target is <strong>unquoted</strong>, that is, it is written without any
surrounding quotation marks.</p>
</div>
</section><section id="set-up-_targets.r-file-to-run-example-analysis"><h2 class="section-heading">Set up <code>_targets.R</code> file to run example analysis<a class="anchor" aria-label="anchor" href="#set-up-_targets.r-file-to-run-example-analysis"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="background-non-targets-version">Background: non-<code>targets</code> version<a class="anchor" aria-label="anchor" href="#background-non-targets-version"></a>
</h3>
<p>We will use this template to start building our analysis of bill
shape in penguins. First though, to get familiar with the functions and
packages we’ll use, let’s run the code like you would in a “normal” R
script without using <code>targets</code>.</p>
<p>Recall that we are using the <code>palmerpenguins</code> R package to
obtain the data. This package actually includes two variations of the
dataset: one is an external CSV file with the raw data, and another is
the cleaned data loaded into R. In real life you are probably have
externally stored raw data, so <strong>let’s use the raw penguin
data</strong> as the starting point for our analysis too.</p>
<p>The <code>path_to_file()</code> function in
<code>palmerpenguins</code> provides the path to the raw data CSV file
(it is inside the <code>palmerpenguins</code> R package source code that
you downloaded to your computer when you installed the package).</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get path to CSV file</span></span>
<span><span class="va">penguins_csv_file</span> <span class="op">&lt;-</span> <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">penguins_csv_file</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "/home/runner/.local/share/renv/cache/v5/R-4.3/x86_64-pc-linux-gnu/palmerpenguins/0.1.1/6c6861efbc13c1d543749e9c7be4a592/palmerpenguins/extdata/penguins_raw.csv"</code></pre>
</div>
<p>We will use the <code>tidyverse</code> set of packages for loading
and manipulating the data. We don’t have time to cover all the details
about using <code>tidyverse</code> now, but if you want to learn more
about it, please see the <a href="https://datacarpentry.org/R-ecology-lesson/03-dplyr.html" class="external-link">“Manipulating,
analyzing and exporting data with tidyverse” lesson</a>.</p>
<p>Let’s load the data with <code>read_csv()</code>.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Read CSV file into R</span></span>
<span><span class="va">penguins_data_raw</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">penguins_csv_file</span><span class="op">)</span></span>
<span></span>
<span><span class="va">penguins_data_raw</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>Rows: 344 Columns: 17
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (9): studyName, Species, Region, Island, Stage, Individual ID, Clutch C...
dbl  (7): Sample Number, Culmen Length (mm), Culmen Depth (mm), Flipper Leng...
date (1): Date Egg

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 344 × 17
   studyName `Sample Number` Species         Region Island Stage `Individual ID`
   &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;           &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt;          
 1 PAL0708                 1 Adelie Penguin… Anvers Torge… Adul… N1A1           
 2 PAL0708                 2 Adelie Penguin… Anvers Torge… Adul… N1A2           
 3 PAL0708                 3 Adelie Penguin… Anvers Torge… Adul… N2A1           
 4 PAL0708                 4 Adelie Penguin… Anvers Torge… Adul… N2A2           
 5 PAL0708                 5 Adelie Penguin… Anvers Torge… Adul… N3A1           
 6 PAL0708                 6 Adelie Penguin… Anvers Torge… Adul… N3A2           
 7 PAL0708                 7 Adelie Penguin… Anvers Torge… Adul… N4A1           
 8 PAL0708                 8 Adelie Penguin… Anvers Torge… Adul… N4A2           
 9 PAL0708                 9 Adelie Penguin… Anvers Torge… Adul… N5A1           
10 PAL0708                10 Adelie Penguin… Anvers Torge… Adul… N5A2           
# ℹ 334 more rows
# ℹ 10 more variables: `Clutch Completion` &lt;chr&gt;, `Date Egg` &lt;date&gt;,
#   `Culmen Length (mm)` &lt;dbl&gt;, `Culmen Depth (mm)` &lt;dbl&gt;,
#   `Flipper Length (mm)` &lt;dbl&gt;, `Body Mass (g)` &lt;dbl&gt;, Sex &lt;chr&gt;,
#   `Delta 15 N (o/oo)` &lt;dbl&gt;, `Delta 13 C (o/oo)` &lt;dbl&gt;, Comments &lt;chr&gt;</code></pre>
</div>
<p>We see the raw data has some awkward column names with spaces (these
are hard to type out and can easily lead to mistakes in the code), and
far more columns than we need. For the purposes of this analysis, we
only need species name, bill length, and bill depth. In the raw data,
the rather technical term “culmen” is used to refer to the bill.</p>
<figure><img src="https://allisonhorst.github.io/palmerpenguins/reference/figures/culmen_depth.png" alt="" class="figure mx-auto d-block"><figcaption>Illustration of bill (culmen) length and depth.
Artwork by <span class="citation">@allison_horst</span>.</figcaption></figure><p>Let’s clean up the data to make it easier to use for downstream
analyses. We will also remove any rows with missing data, because this
could cause errors for some functions later.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Clean up raw data</span></span>
<span><span class="va">penguins_data</span> <span class="op">&lt;-</span> <span class="va">penguins_data_raw</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Rename columns for easier typing and</span></span>
<span>  <span class="co"># subset to only the columns needed for analysis</span></span>
<span>  <span class="fu">select</span><span class="op">(</span></span>
<span>    species <span class="op">=</span> <span class="va">Species</span>,</span>
<span>    bill_length_mm <span class="op">=</span> <span class="va">`Culmen Length (mm)`</span>,</span>
<span>    bill_depth_mm <span class="op">=</span> <span class="va">`Culmen Depth (mm)`</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Delete rows with missing data</span></span>
<span>  <span class="fu">remove_missing</span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">penguins_data</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 342 × 3
   species                             bill_length_mm bill_depth_mm
   &lt;chr&gt;                                        &lt;dbl&gt;         &lt;dbl&gt;
 1 Adelie Penguin (Pygoscelis adeliae)           39.1          18.7
 2 Adelie Penguin (Pygoscelis adeliae)           39.5          17.4
 3 Adelie Penguin (Pygoscelis adeliae)           40.3          18  
 4 Adelie Penguin (Pygoscelis adeliae)           36.7          19.3
 5 Adelie Penguin (Pygoscelis adeliae)           39.3          20.6
 6 Adelie Penguin (Pygoscelis adeliae)           38.9          17.8
 7 Adelie Penguin (Pygoscelis adeliae)           39.2          19.6
 8 Adelie Penguin (Pygoscelis adeliae)           34.1          18.1
 9 Adelie Penguin (Pygoscelis adeliae)           42            20.2
10 Adelie Penguin (Pygoscelis adeliae)           37.8          17.1
# ℹ 332 more rows</code></pre>
</div>
<p>That’s better!</p>
</div>
<div class="section level3">
<h3 id="targets-version">
<code>targets</code> version<a class="anchor" aria-label="anchor" href="#targets-version"></a>
</h3>
<p>What does this look like using <code>targets</code>?</p>
<p>The biggest difference is that we need to <strong>put each step of
the workflow into the list at the end</strong>.</p>
<p>We also define a custom function for the data cleaning step. That is
because the list of targets at the end <strong>should look like a
high-level summary of your analysis</strong>. You want to avoid lengthy
chunks of code when defining the targets; instead, put that code in the
custom functions. The other steps (setting the file path and loading the
data) are each just one function call so there’s not much point in
putting those into their own custom functions.</p>
<p>Finally, each step in the workflow is defined with the
<code>tar_target()</code> function.</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean_penguin_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">penguins_data_raw</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="va">Species</span>,</span>
<span>      bill_length_mm <span class="op">=</span> <span class="va">`Culmen Length (mm)`</span>,</span>
<span>      bill_depth_mm <span class="op">=</span> <span class="va">`Culmen Depth (mm)`</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">remove_missing</span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">list</span><span class="op">(</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span><span class="va">penguins_csv_file</span>, <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span><span class="va">penguins_data_raw</span>, <span class="fu">read_csv</span><span class="op">(</span></span>
<span>    <span class="va">penguins_csv_file</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span><span class="va">penguins_data</span>, <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>I have set <code>show_col_types = FALSE</code> in
<code>read_csv()</code> because we know from the earlier code that the
column types were set correctly by default (character for species and
numeric for bill length and depth), so we don’t need to see the warning
it would otherwise issue.</p>
</div>
</section><section id="run-the-workflow"><h2 class="section-heading">Run the workflow<a class="anchor" aria-label="anchor" href="#run-the-workflow"></a>
</h2>
<hr class="half-width">
<p>Now that we have a workflow, we can run it with the
<code>tar_make()</code> function. Try running it, and you should see
something like this:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target penguins_csv_file
• built target penguins_csv_file [0.003 seconds]
• start target penguins_data_raw
• built target penguins_data_raw [0.33 seconds]
• start target penguins_data
• built target penguins_data [0.012 seconds]
• end pipeline [0.45 seconds]</code></pre>
</div>
<p>Congratulations, you’ve run your first workflow with
<code>targets</code>!</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Projects help keep our analyses organized so we can easily re-run
them later</li>
<li>Use the RStudio Project Wizard to create projects</li>
<li>The <code>_targets.R</code> file is a special file that must be
included in all <code>targets</code> projects, and defines the
worklow</li>
<li>Use <code>tar_script()</code> to create a default
<code>_targets.R</code> file</li>
<li>Use <code>tar_make()</code> to run the workflow</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-cache"><p>Content from <a href="cache.html">Loading Workflow Objects</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/cache.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>Where does the workflow happen?</li>
<li>How can we inspect the objects built by the workflow?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain where <code>targets</code> runs the workflow and why</li>
<li>Be able to load objects built by the workflow into your R
session</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to get at the objects that we built</p>
</div>
</div>
</div>
</div>
<section id="where-does-the-workflow-happen"><h2 class="section-heading">Where does the workflow happen?<a class="anchor" aria-label="anchor" href="#where-does-the-workflow-happen"></a>
</h2>
<hr class="half-width">
<p>So we just finished running our first workflow. Now you probably want
to look at its output. But, if we just call the name of the object (for
example, <code>penguins_data</code>), we get an error.</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penguins_data</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'penguins_data' not found</code></pre>
</div>
<p>Where are the results of our workflow?</p>
<div id="accordionInstructor2" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor2" aria-expanded="false" aria-controls="collapseInstructor2">
  <h3 class="accordion-header" id="headingInstructor2">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor2" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor2" aria-labelledby="headingInstructor2">
<div class="accordion-body">
<ul>
<li>To reinforce the concept of <code>targets</code> running in a
separate R session, you may want to pretend trying to run
<code>penguins_data</code>, then feigning surprise when it doesn’t work
and using it as a teaching moment (errors are pedagogy!).</li>
</ul>
</div>
</div>
</div>
</div>
<p>We don’t see the workflow results because <code>targets</code>
<strong>runs the workflow in a separate R session</strong> that we can’t
interact with. This is for reproducibility—the objects built by the
workflow should only depend on the code in your project, not any
commands you may have interactively given to R.</p>
<p>Fortunately, <code>targets</code> has two functions that can be used
to load objects built by the workflow into our current session,
<code>tar_load()</code> and <code>tar_read()</code>. Let’s see how these
work.</p>
</section><section id="tar_load"><h2 class="section-heading">tar_load()<a class="anchor" aria-label="anchor" href="#tar_load"></a>
</h2>
<hr class="half-width">
<p><code>tar_load()</code> loads an object built by the workflow into
the current session. Its first argument is the name of the object you
want to load. Let’s use this to load <code>penguins_data</code> and get
an overview of the data with <code>summary()</code>.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_load</span><span class="op">(</span><span class="va">penguins_data</span><span class="op">)</span></span>
<span><span class="fu">summary</span><span class="op">(</span><span class="va">penguins_data</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>   species          bill_length_mm  bill_depth_mm  
 Length:342         Min.   :32.10   Min.   :13.10  
 Class :character   1st Qu.:39.23   1st Qu.:15.60  
 Mode  :character   Median :44.45   Median :17.30  
                    Mean   :43.92   Mean   :17.15  
                    3rd Qu.:48.50   3rd Qu.:18.70  
                    Max.   :59.60   Max.   :21.50  </code></pre>
</div>
<p>Note that <code>tar_load()</code> is used for its
<strong>side-effect</strong>—loading the desired object into the current
R session. It doesn’t actually return a value.</p>
</section><section id="tar_read"><h2 class="section-heading">tar_read()<a class="anchor" aria-label="anchor" href="#tar_read"></a>
</h2>
<hr class="half-width">
<p><code>tar_read()</code> is similar to <code>tar_load()</code> in that
it is used to retrieve objects built by the workflow, but unlike
<code>tar_load()</code>, it returns them directly as output.</p>
<p>Let’s try it with <code>penguins_csv_file</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_read</span><span class="op">(</span><span class="va">penguins_csv_file</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "/home/runner/.local/share/renv/cache/v5/R-4.3/x86_64-pc-linux-gnu/palmerpenguins/0.1.1/6c6861efbc13c1d543749e9c7be4a592/palmerpenguins/extdata/penguins_raw.csv"</code></pre>
</div>
<p>We immediately see the contents of <code>penguins_csv_file</code>.
But it has not been loaded into the environment. If you try to run
<code>penguins_csv_file</code> now, you will get an error:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">penguins_csv_file</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error in eval(expr, envir, enclos): object 'penguins_csv_file' not found</code></pre>
</div>
</section><section id="when-to-use-which-function"><h2 class="section-heading">When to use which function<a class="anchor" aria-label="anchor" href="#when-to-use-which-function"></a>
</h2>
<hr class="half-width">
<p><code>tar_load()</code> tends to be more useful when you want to load
objects and do things with them. <code>tar_read()</code> is more useful
when you just want to immediately inspect an object.</p>
</section><section id="the-targets-cache"><h2 class="section-heading">The targets cache<a class="anchor" aria-label="anchor" href="#the-targets-cache"></a>
</h2>
<hr class="half-width">
<p>If you close your R session, then re-start it and use
<code>tar_load()</code> or <code>tar_read()</code>, you will notice that
it can still load the workflow objects. In other words, the workflow
output is <strong>saved across R sessions</strong>. How is this
possible?</p>
<p>You may have noticed a new folder has appeared in your project,
called <code>_targets</code>. This is the <strong>targets
cache</strong>. It contains all of the workflow output; that is how we
can load the targets built by the workflow even after quitting then
restarting R.</p>
<p><strong>You should not edit the contents of the cache by
hand</strong> (with one exception). Doing so would make your analysis
non-reproducible.</p>
<p>The one exception to this rule is a special subfolder called
<code>_targets/user</code>. This folder does not exist by default. You
can create it if you want, and put whatever you want inside.</p>
<p>Generally, <code>_targets/user</code> is a good place to store files
that are not code, like data and output.</p>
<p>Note that if you don’t have anything in <code>_targets/user</code>
that you need to keep around, it is possible to “reset” your workflow by
simply deleting the entire <code>_targets</code> folder. Of course, this
means you will need to run everything over again, so don’t do this
lightly!</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>
<code>targets</code> workflows are run in a separate,
non-interactive R session</li>
<li>
<code>tar_load()</code> loads a workflow object into the current R
session</li>
<li>
<code>tar_read()</code> reads a workflow object and returns its
value</li>
<li>The <code>_targets</code> folder is the cache and generally should
not be edited by hand</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-lifecycle"><p>Content from <a href="lifecycle.html">The Workflow Lifecycle</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/lifecycle.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What happens if we re-run a workflow?</li>
<li>How does <code>targets</code> know what steps to re-run?</li>
<li>How can we inspect the state of the workflow?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain how <code>targets</code> helps increase efficiency</li>
<li>Be able to inspect a workflow to see what parts are outdated</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Demonstrate typical cycle of running
<code>targets</code>: make, inspect, adjust, make…</p>
</div>
</div>
</div>
</div>
<section id="re-running-the-workflow"><h2 class="section-heading">Re-running the workflow<a class="anchor" aria-label="anchor" href="#re-running-the-workflow"></a>
</h2>
<hr class="half-width">
<p>One of the features of <code>targets</code> is that it maximizes
efficiency by only running the parts of the workflow that need to be
run.</p>
<p>This is easiest to understand by trying it yourself. Let’s try
running the workflow again:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_csv_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
✔ skip pipeline [0.088 seconds]</code></pre>
</div>
<p>Remember how the first time we ran the pipeline, <code>targets</code>
printed out a list of each target as it was being built?</p>
<p>This time, it tells us it is skipping those targets; they have
already been built, so there’s no need to run that code again.</p>
<p>Remember, the fastest code is the code you don’t have to run!</p>
</section><section id="re-running-the-workflow-after-modification"><h2 class="section-heading">Re-running the workflow after modification<a class="anchor" aria-label="anchor" href="#re-running-the-workflow-after-modification"></a>
</h2>
<hr class="half-width">
<p>What happens when we change one part of the workflow then run it
again?</p>
<p>Say that we decide the species names should be shorter. Right now
they include the common name and the scientific name, but we really only
need the first part of the common name to distinguish them.</p>
<p>Edit <code>_targets.R</code> so that the
<code>clean_penguin_data()</code> function looks like this:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clean_penguin_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">penguins_data_raw</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="va">Species</span>,</span>
<span>      bill_length_mm <span class="op">=</span> <span class="va">`Culmen Length (mm)`</span>,</span>
<span>      bill_depth_mm <span class="op">=</span> <span class="va">`Culmen Depth (mm)`</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">remove_missing</span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="co"># Split "species" apart on spaces, and only keep the first word</span></span>
<span>    <span class="fu">separate</span><span class="op">(</span><span class="va">species</span>, into <span class="op">=</span> <span class="st">"species"</span>, extra <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Then run it again.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_csv_file
✔ skip target penguins_data_raw
• start target penguins_data
• built target penguins_data [0.024 seconds]
• end pipeline [0.144 seconds]</code></pre>
</div>
<p>What happened?</p>
<p>This time, it skipped <code>penguins_csv_file</code> and
<code>penguins_data_raw</code> and only ran
<code>penguins_data</code>.</p>
<p>Of course, since our example workflow is so short we don’t even
notice the amount of time saved. But imagine using this in a series of
computationally intensive analysis steps. The ability to automatically
skip steps results in a massive increase in efficiency.</p>
<div id="challenge-1-inspect-the-output" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-1-inspect-the-output" class="callout-inner">
<h3 class="callout-title">Challenge 1: Inspect the output<a class="anchor" aria-label="anchor" href="#challenge-1-inspect-the-output"></a>
</h3>
<div class="callout-content">
<p>How can you inspect the contents of <code>penguins_data</code>?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>With <code>tar_read(penguins_data</code>) or by running
<code>tar_load(penguins_data)</code> followed by
<code>penguins_data</code>.</p>
</div>
</div>
</div>
</div>
</section><section id="under-the-hood"><h2 class="section-heading">Under the hood<a class="anchor" aria-label="anchor" href="#under-the-hood"></a>
</h2>
<hr class="half-width">
<p>How does <code>targets</code> keep track of which targets are
up-to-date vs. outdated?</p>
<p>For each target in the workflow (items in the list at the end of the
<code>_targets.R</code> file) and any custom functions used in the
workflow, <code>targets</code> calculates a <strong>hash value</strong>,
or unique combination of letters and digits that represents an object in
the computer’s memory. You can think of the hash value (or “hash” for
short) as <strong>a unique fingerprint</strong> for a target or
function.</p>
<p>The first time your run <code>tar_make()</code>, <code>targets</code>
calculates the hashes for each target and function as it runs the code
and stores them in the targets cache (the <code>_targets</code> folder).
Then, for each subsequent call of <code>tar_make()</code>, it calculates
the hashes again and compares them to the stored values. It detects
which have changed, and this is how it knows which targets are out of
date.</p>
<div id="where-the-hashes-live" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="where-the-hashes-live" class="callout-inner">
<h3 class="callout-title">Where the hashes live<a class="anchor" aria-label="anchor" href="#where-the-hashes-live"></a>
</h3>
<div class="callout-content">
<p>If you are curious about what the hashes look like, you can see them
in the file <code>_targets/meta/meta</code>, but <strong>do not edit
this file by hand</strong>—that would ruin your workflow!</p>
</div>
</div>
</div>
<p>This information is used in combination with the dependency
relationships (in other words, how each target depends on the others) to
re-run the workflow in the most efficient way possible: code is only run
for targets that need to be re-built, and others are skipped.</p>
</section><section id="visualizing-the-workflow"><h2 class="section-heading">Visualizing the workflow<a class="anchor" aria-label="anchor" href="#visualizing-the-workflow"></a>
</h2>
<hr class="half-width">
<p>Typically, you will be making edits to various places in your code,
adding new targets, and running the workflow periodically. It is good to
be able to visualize the state of the workflow.</p>
<p>This can be done with <code>tar_visnetwork()</code></p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_visnetwork</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<figure><img src="../fig/lifecycle-visnetwork.png" alt="Visualization of the targets worklow, showing 'penguins_data' connected by lines to 'penguins_data_raw', 'penguins_csv_file' and 'clean_penguin_data'" class="figure mx-auto d-block"></figure><p>You should see the network show up in the plot area of RStudio.</p>
<p>It is an HTML widget, so you can zoom in and out (this isn’t
important for the current example since it is so small, but is useful
for larger, “real-life” workflows).</p>
<p>Here, we see that all of the targets are dark green, indicating that
they are up-to-date and would be skipped if we were to run the workflow
again.</p>
<div id="installing-visnetwork" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="installing-visnetwork" class="callout-inner">
<h3 class="callout-title">Installing visNetwork<a class="anchor" aria-label="anchor" href="#installing-visnetwork"></a>
</h3>
<div class="callout-content">
<p>You may encounter an error message
<code>The package "visNetwork" is required.</code></p>
<p>In this case, install it first with
<code>install.packages("visNetwork")</code>.</p>
</div>
</div>
</div>
<div id="challenge-2-what-else-can-the-visualization-tell-us" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-2-what-else-can-the-visualization-tell-us" class="callout-inner">
<h3 class="callout-title">Challenge 2: What else can the visualization
tell us?<a class="anchor" aria-label="anchor" href="#challenge-2-what-else-can-the-visualization-tell-us"></a>
</h3>
<div class="callout-content">
<p>Modify the workflow in <code>_targets.R</code>, then run
<code>tar_visnetwork()</code> again <strong>without</strong> running
<code>tar_make()</code>. What color indicates that a target is out of
date?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Light blue indicates the target is out of date.</p>
<p>Depending on how you modified the code, any or all of the targets may
now be light blue.</p>
</div>
</div>
</div>
</div>
<div id="outdated-does-not-always-mean-will-be-run" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="outdated-does-not-always-mean-will-be-run" class="callout-inner">
<h3 class="callout-title">‘Outdated’ does not always mean ‘will be
run’<a class="anchor" aria-label="anchor" href="#outdated-does-not-always-mean-will-be-run"></a>
</h3>
<div class="callout-content">
<p>Just because a target appears as light blue (is “outdated”) in the
network visualization, this does not guarantee that it will be re-built
during the next run. Rather, it means that <strong>at least of one the
targets that it depends on has changed</strong>.</p>
<p>For example, if the workflow state looked like this:</p>
<p><code>A -&gt; B* -&gt; C -&gt; D</code></p>
<p>where the <code>*</code> indicates that <code>B</code> has changed
compared to the last time the workflow was run, the network
visualization will show <code>B</code>, <code>C</code>, and
<code>D</code> all as light blue.</p>
<p>But if re-running the workflow results in the exact same value for
<code>C</code> as before, <code>D</code> will not be re-run (will be
“skipped”).</p>
<p>Most of the time, a single change will cascade to the rest of the
downstream targets and cause them to be re-built, but this is not always
the case. <code>targets</code> has no way of knowing ahead of time what
the actual output will be, so it cannot provide a network visualization
that completely predicts the future!</p>
</div>
</div>
</div>
</section><section id="other-ways-to-check-workflow-status"><h2 class="section-heading">Other ways to check workflow status<a class="anchor" aria-label="anchor" href="#other-ways-to-check-workflow-status"></a>
</h2>
<hr class="half-width">
<p>The visualization is very useful, but sometimes you may be working on
a server that doesn’t provide graphical output, or you just want a quick
textual summary of the workflow. There are some other useful functions
that can do that.</p>
<p><code>tar_outdated()</code> lists only the outdated targets; that is,
targets that will be built during the next run, or depend on such a
target. If everything is up to date, it will return a zero-length
character vector (<code>character(0)</code>).</p>
<p><code>tar_progress()</code> shows the current status of the workflow
as a dataframe. You may find it helpful to further manipulate the
dataframe to obtain useful summaries of the workflow, for example using
<code>dplyr</code> (such data manipulation is beyond the scope of this
lesson but the instructor may demonstrate its use).</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_outdated</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="fu">character</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_progress</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 3 × 2
  name              progress
  &lt;chr&gt;             &lt;chr&gt;   
1 penguins_csv_file skipped 
2 penguins_data_raw skipped 
3 penguins_data     skipped </code></pre>
</div>
</section><section id="granular-control-of-targets"><h2 class="section-heading">Granular control of targets<a class="anchor" aria-label="anchor" href="#granular-control-of-targets"></a>
</h2>
<hr class="half-width">
<p>It is possible to only make a particular target instead of running
the entire workflow.</p>
<p>To do this, type the name of the target you wish to build after
<code>tar_make()</code> (note that any targets required by the one you
specify will also be built). For example,
<code>tar_make(penguins_data_raw)</code> would <strong>only</strong>
build <code>penguins_data_raw</code>, not
<code>penguins_data</code>.</p>
<p>Furthermore, if you want to manually “reset” a target and make it
appear out-of-date, you can do so with <code>tar_invalidate()</code>.
This means that target (and any that depend on it) will be re-run next
time.</p>
<p>Let’s give this a try. Remember that our pipeline is currently up to
date, so <code>tar_make()</code> will skip everything:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_csv_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
✔ skip pipeline [0.079 seconds]</code></pre>
</div>
<p>Let’s invalidate <code>penguins_data</code> and run it again:</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_invalidate</span><span class="op">(</span><span class="va">penguins_data</span><span class="op">)</span></span>
<span><span class="fu">tar_make</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_csv_file
✔ skip target penguins_data_raw
• start target penguins_data
• built target penguins_data [0.023 seconds]
• end pipeline [0.133 seconds]</code></pre>
</div>
<p>If you want to reset <strong>everything</strong> and start fresh, you
can use <code>tar_invalidate(everything())</code>
(<code>tar_invalidate()</code> <a href="https://docs.ropensci.org/targets/reference/tar_invalidate.html" class="external-link">accepts
<code>tidyselect</code> expressions</a> to specify target names).</p>
<p><strong>Caution should be exercised</strong> when using granular
methods like this, though, since you may end up with your workflow in an
unexpected state. The surest way to maintain an up-to-date workflow is
to run <code>tar_make()</code> frequently.</p>
</section><section id="how-this-all-works-in-practice"><h2 class="section-heading">How this all works in practice<a class="anchor" aria-label="anchor" href="#how-this-all-works-in-practice"></a>
</h2>
<hr class="half-width">
<p>In practice, you will likely be switching between running the
workflow with <code>tar_make()</code>, loading the targets you built
with <code>tar_load()</code>, and editing your custom functions by
running code in an interactive R session. It takes some time to get used
to it, but soon you will feel that your code isn’t “real” until it is
embedded in a <code>targets</code> workflow.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>
<code>targets</code> only runs the steps that have been affected by
a change to the code</li>
<li>
<code>tar_visnetwork()</code> shows the current state of the
workflow as a network</li>
<li>
<code>tar_progress()</code> shows the current state of the workflow
as a data frame</li>
<li>
<code>tar_outdated()</code> lists outdated targets</li>
<li>
<code>tar_invalidate()</code> can be used to invalidate (re-run)
specific targets</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-organization"><p>Content from <a href="organization.html">Best Practices for targets Project Organization</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/organization.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>What are best practices for organizing <code>targets</code>
projects?</li>
<li>How does the organization of a <code>targets</code> workflow differ
from a script-based analysis?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Explain how to organize <code>targets</code> projects for maximal
reproducibility</li>
<li>Understand how to use functions in the context of
<code>targets</code>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Demonstrate best-practices for project
organization</p>
</div>
</div>
</div>
</div>
<section id="a-simpler-way-to-write-workflow-plans"><h2 class="section-heading">A simpler way to write workflow plans<a class="anchor" aria-label="anchor" href="#a-simpler-way-to-write-workflow-plans"></a>
</h2>
<hr class="half-width">
<p>The default way to specify targets in the plan is with the
<code>tar_target()</code> function. But this way of writing plans can be
a bit verbose.</p>
<p>There is an alternative provided by the <code>tarchetypes</code>
package, also written by the creator of <code>targets</code>, Will
Landau.</p>
<div id="install-tarchetypes" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="install-tarchetypes" class="callout-inner">
<h3 class="callout-title">Install <code>tarchetypes</code><a class="anchor" aria-label="anchor" href="#install-tarchetypes"></a>
</h3>
<div class="callout-content">
<p>If you haven’t done so yet, install <code>tarchetypes</code> with
<code>install.packages("tarchetypes")</code>.</p>
</div>
</div>
</div>
<p>The purpose of the <code>tarchetypes</code> is to provide various
shortcuts that make writing <code>targets</code> pipelines easier. We
will introduce just one for now, <code>tar_plan()</code>. This is used
in place of <code>list()</code> at the end of the
<code>_targets.R</code> script. By using <code>tar_plan()</code>,
instead of specifying targets with <code>tar_target()</code>, we can use
a syntax like this: <code>target_name = target_command</code>.</p>
<p>Let’s edit the penguins workflow to use the <code>tar_plan()</code>
syntax:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clean_penguin_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">penguins_data_raw</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">select</span><span class="op">(</span></span>
<span>      species <span class="op">=</span> <span class="va">Species</span>,</span>
<span>      bill_length_mm <span class="op">=</span> <span class="va">`Culmen Length (mm)`</span>,</span>
<span>      bill_depth_mm <span class="op">=</span> <span class="va">`Culmen Depth (mm)`</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">remove_missing</span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  penguins_csv_file <span class="op">=</span> <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>  penguins_data_raw <span class="op">=</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">penguins_csv_file</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>I think it is easier to read, do you?</p>
<p>Notice that <code>tar_plan()</code> does not mean you have to write
<em>all</em> targets this way; you can still use the
<code>tar_target()</code> format within <code>tar_plan()</code>. That is
because <code>=</code>, while short and easy to read, does not provide
all of the customization that <code>targets</code> is capable of. This
doesn’t matter so much for now, but it will become important when you
start to create more advanced <code>targets</code> workflows.</p>
</section><section id="organizing-files-and-folders"><h2 class="section-heading">Organizing files and folders<a class="anchor" aria-label="anchor" href="#organizing-files-and-folders"></a>
</h2>
<hr class="half-width">
<p>So far, we have been doing everything with a single
<code>_targets.R</code> file. This is OK for a small workflow, but does
not work very well when the workflow gets bigger. There are better ways
to organize your code.</p>
<p>First, let’s create a directory called <code>R</code> to store R code
<em>other than</em> <code>_targets.R</code> (remember,
<code>_targets.R</code> must be placed in the overall project directory,
not in a subdirectory). Create a new R file in <code>R/</code> called
<code>functions.R</code>. This is where we will put our custom
functions. Let’s go ahead and put <code>clean_penguin_data()</code> in
there now and save it.</p>
<p>Similarly, let’s put the <code>library()</code> calls in their own
script in <code>R/</code> called <code>packages.R</code> (this isn’t the
only way to do it though; see the <a href="https://joelnitta.github.io/targets-workshop/packages.html" class="external-link">“Managing
Packages” episode</a> for alternative approaches).</p>
<p>We will also need to modify our <code>_targets.R</code> script to
call these scripts with <code>source</code>:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  penguins_csv_file <span class="op">=</span> <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>  penguins_data_raw <span class="op">=</span> <span class="fu">read_csv</span><span class="op">(</span><span class="va">penguins_csv_file</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Now <code>_targets.R</code> is much more streamlined: it is focused
just on the workflow and immediately tells us what happens in each
step.</p>
<p>Finally, let’s make some directories for storing data and
output—files that are not code. Create a new directory inside the
targets cache called <code>user</code>: <code>_targets/user</code>.
Within <code>user</code>, create two more directories, <code>data</code>
and <code>results</code>. (If you use version control, you will probably
want to ignore the <code>_targets</code> directory).</p>
</section><section id="a-word-about-functions"><h2 class="section-heading">A word about functions<a class="anchor" aria-label="anchor" href="#a-word-about-functions"></a>
</h2>
<hr class="half-width">
<p>We mentioned custom functions earlier in the lesson, but this is an
important topic that deserves further clarification. If you are used to
analyzing data in R with a series of scripts instead of a single
workflow like <code>targets</code>, you may not write many functions
(using the <code>function()</code> function).</p>
<p>This is a major difference from <code>targets</code>. It would be
quite difficult to write an efficient <code>targets</code> pipeline
without the use of custom functions, because each target you build has
to be the output of a single command.</p>
<p>We don’t have time in this curriculum to cover how to write functions
in R, but the <a href="https://swcarpentry.github.io/r-novice-gapminder/10-functions" class="external-link">Software
Carpentry lesson</a> is recommended for reviewing this topic.</p>
<p>Another major difference is that <strong>each target must have a
unique name</strong>. You may be used to writing code that looks like
this:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Store a person's height in cm, then convert to inches</span></span>
<span><span class="va">height</span> <span class="op">&lt;-</span> <span class="fl">160</span></span>
<span><span class="va">height</span> <span class="op">&lt;-</span> <span class="va">height</span> <span class="op">/</span> <span class="fl">2.54</span></span></code></pre>
</div>
<p>You would get an error if you tried to run the equivalent targets
pipeline:</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  height <span class="op">=</span> <span class="fl">160</span>,</span>
<span>  height <span class="op">=</span> <span class="va">height</span> <span class="op">/</span> <span class="fl">2.54</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error:
! Error running targets::tar_make()
  Error messages: targets::tar_meta(fields = error, complete_only = TRUE)
  Debugging guide: https://books.ropensci.org/targets/debugging.html
  How to ask for help: https://books.ropensci.org/targets/help.html
  Last error: duplicated target names: height</code></pre>
</div>
<p><strong>A major part of working with <code>targets</code> pipelines
is writing custom functions that are the right size.</strong> They
should not be so small that each is just a single line of code; this
would make your pipeline difficult to understand and be too difficult to
maintain. On the other hand, they should not be so big that each has
large numbers of inputs and is thus overly sensitive to changes.</p>
<p>Striking this balance is more of art than science, and only comes
with practice. I find a good rule of thumb is no more than three inputs
per target.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Put code in the <code>R/</code> folder</li>
<li>Put functions in <code>R/functions.R</code>
</li>
<li>Specify packages in <code>R/packages.R</code>
</li>
<li>Put other miscellaneous files in <code>_targets/user</code>
</li>
<li>Writing functions is a key skill for <code>targets</code>
pipelines</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-packages"><p>Content from <a href="packages.html">Managing Packages</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/packages.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How should I manage packages for my <code>targets</code>
project?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Demonstrate best practices for managing packages</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to load packages and maintain package
versions</p>
</div>
</div>
</div>
</div>
<section id="loading-packages"><h2 class="section-heading">Loading packages<a class="anchor" aria-label="anchor" href="#loading-packages"></a>
</h2>
<hr class="half-width">
<p>Almost every R analysis relies on packages for functions beyond those
available in base R.</p>
<p>There are three main ways to load packages in <code>targets</code>
workflows.</p>
<div class="section level3">
<h3 id="method-1">Method 1: <code>library()</code>
<a class="anchor" aria-label="anchor" href="#method-1"></a>
</h3>
<p>This is the method you are almost certainly more familiar with, and
is the method we have been using by default so far.</p>
<p>Like any other R script, include <code>library()</code> calls near
the top of the <code>_targets.R</code> script. Alternatively (and as the
<!-- FIXME ADD LINK -->recommended best practice for project
organization), you can put all of the <code>library()</code> calls in a
separate script—this is typically called <code>packages.R</code> and
stored in the <code>R/</code> directory of your project.</p>
<p>The potential downside to this approach is that if you have a long
list of packages to load, certain functions like
<code>tar_visnetwork()</code>, <code>tar_outdated()</code>, etc., may
take an unnecessarily long time to run because they have to load all the
packages, even though they don’t necessarily use them.</p>
</div>
<div class="section level3">
<h3 id="method-2">Method 2: <code>tar_option_set()</code>
<a class="anchor" aria-label="anchor" href="#method-2"></a>
</h3>
<p>In this method, use the <code>tar_option_set()</code> function in
<code>_targets.R</code> to specify the packages to load when running the
workflow.</p>
<p>This will be demonstrated using the pre-cleaned dataset from the
<code>palmerpenguins</code> package. Let’s say we want to filter it down
to just data for the Adelie penguin.</p>
<div id="save-your-progress" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="save-your-progress" class="callout-inner">
<h3 class="callout-title">Save your progress<a class="anchor" aria-label="anchor" href="#save-your-progress"></a>
</h3>
<div class="callout-content">
<p>You can only have one active <code>_targets.R</code> file at a time
in a given project.</p>
<p>We are about to create a new <code>_targets.R</code> file, but you
probably don’t want to lose your progress in the one we have been
working on so far (the penguins bill analysis). You can temporarily
rename that one to something like <code>_targets_old.R</code> so that
you don’t overwrite it with the new example <code>_targets.R</code> file
below. Then, rename them when you are ready to work on it again.</p>
</div>
</div>
</div>
<p>This is what using the <code>tar_option_set()</code> method looks
like:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_option_set</span><span class="op">(</span>packages <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"palmerpenguins"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  adelie_data <span class="op">=</span> <span class="fu">filter</span><span class="op">(</span><span class="va">penguins</span>, <span class="va">species</span> <span class="op">==</span> <span class="st">"Adelie"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target adelie_data
• built target adelie_data [0.029 seconds]
• end pipeline [0.124 seconds]</code></pre>
</div>
<p>This method gets around the slow-downs that may sometimes be
experienced with Method 1.</p>
</div>
<div class="section level3">
<h3 id="method-3">Method 3: <code>packages</code> argument of
<code>tar_target()</code>
<a class="anchor" aria-label="anchor" href="#method-3"></a>
</h3>
<p>The main function for defining targets, <code>tar_target()</code>
includes a <code>packages</code> argument that will load the specified
packages <strong>only for that target</strong>.</p>
<p>Here is how we could use this method, modified from the same example
as above.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">adelie_data</span>,</span>
<span>    <span class="fu">filter</span><span class="op">(</span><span class="va">penguins</span>, <span class="va">species</span> <span class="op">==</span> <span class="st">"Adelie"</span><span class="op">)</span>,</span>
<span>    packages <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"palmerpenguins"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target adelie_data
• built target adelie_data [0.029 seconds]
• end pipeline [0.124 seconds]</code></pre>
</div>
<p>This can be more memory efficient in some cases than loading all
packages, since not every target is always made during a typical run of
the workflow. But, it can be tedious to remember and specify packages
needed on a per-target basis.</p>
</div>
<div class="section level3">
<h3 id="one-more-option">One more option<a class="anchor" aria-label="anchor" href="#one-more-option"></a>
</h3>
<p>Another alternative that does not actually involve loading packages
is to specify the package associated with each function by using the
<code>::</code> notation, for example, <code>dplyr::mutate()</code>.
This means you can <strong>avoid loading packages
altogether</strong>.</p>
<p>Here is how to write the plan using this method:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  adelie_data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu">filter</span><span class="op">(</span><span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span>, <span class="va">species</span> <span class="op">==</span> <span class="st">"Adelie"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target adelie_data
• built target adelie_data [0.015 seconds]
• end pipeline [0.112 seconds]</code></pre>
</div>
<p>The benefits of this approach are that the origins of all functions
is explicit, so you could browse your code (for example, by looking at
its source in GitHub), and immediately know where all the functions come
from. The downside is that it is rather verbose because you need to type
the package name every time you use one of its functions.</p>
</div>
<div class="section level3">
<h3 id="which-is-the-right-way">Which is the right way?<a class="anchor" aria-label="anchor" href="#which-is-the-right-way"></a>
</h3>
<p><strong>There is no “right” answer about how to load
packages</strong>—it is a matter of what works best for your particular
situation.</p>
<p>Often a reasonable approach is to load your most commonly used
packages with <code>library()</code> (such as <code>tidyverse</code>) in
<code>packages.R</code>, then use <code>::</code> notation for less
frequently used functions whose origins you may otherwise forget.</p>
</div>
</section><section id="maintaining-package-versions"><h2 class="section-heading">Maintaining package versions<a class="anchor" aria-label="anchor" href="#maintaining-package-versions"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="tracking-of-custom-functions-vs--functions-from-packages">Tracking of custom functions vs. functions from packages<a class="anchor" aria-label="anchor" href="#tracking-of-custom-functions-vs--functions-from-packages"></a>
</h3>
<p>A critical thing to understand about <code>targets</code> is that
<strong>it only tracks custom functions and targets</strong>, not
functions provided by packages.</p>
<p>However, the content of packages can change, and packages typically
get updated on a regular basis. <strong>The output of your workflow may
depend not only on the packages you use, but their
versions</strong>.</p>
<p>Therefore, it is a good idea to track package versions.</p>
</div>
<div class="section level3">
<h3 id="about-renv">About <code>renv</code>
<a class="anchor" aria-label="anchor" href="#about-renv"></a>
</h3>
<p>Fortunately, you don’t have to do this by hand: there are R packages
available that can help automate this process. We recommend <a href="https://rstudio.github.io/renv/index.html" class="external-link">renv</a>, but there are
others available as well (e.g., <a href="https://groundhogr.com/" class="external-link">groundhog</a>). We don’t have the time to
cover detailed usage of <code>renv</code> in this lesson. To get started
with <code>renv</code>, see the <a href="https://rstudio.github.io/renv/articles/renv.html" class="external-link">“Introduction
to renv” vignette</a>.</p>
<p>You can generally use <code>renv</code> the same way you would for a
<code>targets</code> project as any other R project. However, there is
one exception: if you load packages using <code>tar_option_set()</code>
or the <code>packages</code> argument of <code>tar_target()</code> (<a href="#method-2">Method 2</a> or <a href="#method-3">Method 3</a>,
respectively), <code>renv</code> will not detect them (because it
expects packages to be loaded with <code>library()</code>,
<code>require()</code>, etc.).</p>
<p>The solution in this case is to use the <a href="https://docs.ropensci.org/targets/reference/tar_renv.html" class="external-link"><code>tar_renv()</code>
function</a>. This will write a separate file with
<code>library()</code> calls for each package used in the workflow so
that <code>renv</code> will properly detect them.</p>
</div>
<div class="section level3">
<h3 id="selective-tracking-of-functions-from-packages">Selective tracking of functions from packages<a class="anchor" aria-label="anchor" href="#selective-tracking-of-functions-from-packages"></a>
</h3>
<p>Because <code>targets</code> doesn’t track functions from packages,
if you update a package and the contents of one of its functions
changes, <code>targets</code> <strong>will not re-build the target that
was generated by that function</strong>.</p>
<p>However, it is possible to change this behavior on a per-package
basis. This is best done only for a small number of packages, since
adding too many would add too much computational overhead to
<code>targets</code> when it has to calculate dependencies. For example,
you may want to do this if you are using your own custom package that
you update frequently.</p>
<p>The way to do so is by using <code>tar_option_set()</code>,
specifying the <strong>same</strong> package name in both
<code>packages</code> and <code>imports</code>. Here is a modified
version of the earlier code that demonstrates this for
<code>dplyr</code> and <code>palmerpenguins</code>.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_option_set</span><span class="op">(</span></span>
<span>  packages <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"palmerpenguins"</span><span class="op">)</span>,</span>
<span>  imports <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"palmerpenguins"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  adelie_data <span class="op">=</span> <span class="fu">filter</span><span class="op">(</span><span class="va">penguins</span>, <span class="va">species</span> <span class="op">==</span> <span class="st">"Adelie"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>If we were to re-install either <code>dplyr</code> or
<code>palmerpenguins</code> and one of the functions used from those in
the pipeline changes (for example, <code>filter()</code>), any target
depending on that function will be rebuilt.</p>
</div>
</section><section id="resolving-namespace-conflicts"><h2 class="section-heading">Resolving namespace conflicts<a class="anchor" aria-label="anchor" href="#resolving-namespace-conflicts"></a>
</h2>
<hr class="half-width">
<p>There is one final best-practice to mention related to packages:
resolving namespace conflicts.</p>
<p>“Namespace” refers to the idea that a certain set of unique names are
only unique <strong>within a particular context</strong>. For example,
all the function names of a package have to be unique, but only within
that package. Function names could be duplicated across packages.</p>
<p>As you may imagine, this can cause confusion. For example, the
<code>filter()</code> function appears in both the <code>stats</code>
package and the <code>dplyr</code> package, but does completely
different things in each. This is a <strong>namespace conflict</strong>:
how do we know which <code>filter()</code> we are talking about?</p>
<p>The <code>conflicted</code> package can help prevent such confusion
by stopping you if you try to use an ambiguous function, and help you be
explicit about which package to use. We don’t have time to cover the
details here, but you can read more about how to use
<code>conflicted</code> at its <a href="https://conflicted.r-lib.org/" class="external-link">website</a>.</p>
<p>When you use <code>conflicted</code>, you will typically run a series
of commands to explicitly resolve namespace conflicts, like
<code>conflicts_prefer(dplyr::filter)</code> (this would tell R that we
want to use <code>filter</code> from <code>dplyr</code>, not
<code>stats</code>).</p>
<p>To use this in a <code>targets</code> workflow, you should put all
calls to <code>conflicts_prefer</code> in a special file called
<code>.Rprofile</code> that is located in the main folder of your
project. This will ensure that the conflicts are always resolved for
each target.</p>
<p>The recommended way to edit your <code>.Rprofile</code> is to use
<code>usethis::edit_r_profile("project")</code>. This will open
<code>.Rprofile</code> in your editor, where you can edit it and save
it.</p>
<p>For example, your <code>.Rprofile</code> could include this:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">conflicted</span><span class="op">)</span></span>
<span><span class="fu">conflicts_prefer</span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="va">filter</span><span class="op">)</span></span></code></pre>
</div>
<p>Note that you don’t need to run <code>source()</code> to run the code
in <code>.Rprofile</code>. It will always get run at the start of each R
session automatically.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>There are multiple ways to load packages with
<code>targets</code>
</li>
<li>
<code>targets</code> only tracks user-defined functions, not
packages</li>
<li>Use <code>renv</code> to manage package versions</li>
<li>Use the <code>conflicted</code> package to manage namespace
conflicts</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-files"><p>Content from <a href="files.html">Working with External Files</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/files.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we load external data?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Be able to load external data into a workflow</li>
<li>Configure the workflow to rerun if the contents of the external data
change</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to read and write external files</p>
</div>
</div>
</div>
</div>
<section id="treating-external-files-as-a-dependency"><h2 class="section-heading">Treating external files as a dependency<a class="anchor" aria-label="anchor" href="#treating-external-files-as-a-dependency"></a>
</h2>
<hr class="half-width">
<p>Almost all workflows will start by importing data, which is typically
stored as an external file.</p>
<p>As a simple example, let’s create an external data file in RStudio
with the “New File” menu option. Enter a single line of text, “Hello
World” and save it as “hello.txt” text file in
<code>_targets/user/data/</code>.</p>
<p>We will read in the contents of this file and store it as
<code>some_data</code> in the workflow by writing the following plan and
running <code>tar_make()</code>:</p>
<div id="save-your-progress" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="save-your-progress" class="callout-inner">
<h3 class="callout-title">Save your progress<a class="anchor" aria-label="anchor" href="#save-your-progress"></a>
</h3>
<div class="callout-content">
<p>You can only have one active <code>_targets.R</code> file at a time
in a given project.</p>
<p>We are about to create a new <code>_targets.R</code> file, but you
probably don’t want to lose your progress in the one we have been
working on so far (the penguins bill analysis). You can temporarily
rename that one to something like <code>_targets_old.R</code> so that
you don’t overwrite it with the new example <code>_targets.R</code> file
below. Then, rename them when you are ready to work on it again.</p>
</div>
</div>
</div>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  some_data <span class="op">=</span> <span class="fu">readLines</span><span class="op">(</span><span class="st">"_targets/user/data/hello.txt"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target some_data
• built target some_data [0.002 seconds]
• end pipeline [0.098 seconds]</code></pre>
</div>
<p>If we inspect the contents of <code>some_data</code> with
<code>tar_read(some_data)</code>, it will contain the string
<code>"Hello World"</code> as expected.</p>
<p>Now say we edit “hello.txt”, perhaps add some text: “Hello World. How
are you?”. Edit this in the RStudio text editor and save it. Now run the
pipeline again.</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  some_data <span class="op">=</span> <span class="fu">readLines</span><span class="op">(</span><span class="st">"_targets/user/data/hello.txt"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target some_data
✔ skip pipeline [0.079 seconds]</code></pre>
</div>
<p>The target <code>some_data</code> was skipped, even though the
contents of the file changed.</p>
<p>That is because right now, targets is only tracking the
<strong>name</strong> of the file, not its contents. We need to use a
special function for that, <code>tar_file()</code> from the
<code>tarchetypes</code> package. <code>tar_file()</code> will calculate
the “hash” of a file—a unique digital signature that is determined by
the file’s contents. If the contents change, the hash will change, and
this will be detected by <code>targets</code>.</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="fu">tar_file</span><span class="op">(</span><span class="va">data_file</span>, <span class="st">"_targets/user/data/hello.txt"</span><span class="op">)</span>,</span>
<span>  some_data <span class="op">=</span> <span class="fu">readLines</span><span class="op">(</span><span class="va">data_file</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target data_file
• built target data_file [0.001 seconds]
• start target some_data
• built target some_data [0.001 seconds]
• end pipeline [0.109 seconds]</code></pre>
</div>
<p>This time we see that <code>targets</code> does successfully re-build
<code>some_data</code> as expected.</p>
</section><section id="a-shortcut-or-about-target-factories"><h2 class="section-heading">A shortcut (or, About target factories)<a class="anchor" aria-label="anchor" href="#a-shortcut-or-about-target-factories"></a>
</h2>
<hr class="half-width">
<p>However, also notice that this means we need to write two targets
instead of one: one target to track the contents of the file
(<code>data_file</code>), and one target to store what we load from the
file (<code>some_data</code>).</p>
<p>It turns out that this is a common pattern in <code>targets</code>
workflows, so <code>tarchetypes</code> provides a shortcut to express
this more concisely, <code>tar_file_read()</code>.</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">hello</span>,</span>
<span>    <span class="st">"_targets/user/data/hello.txt"</span>,</span>
<span>    <span class="fu">readLines</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Let’s inspect this pipeline with <code>tar_manifest()</code>:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_manifest</span><span class="op">(</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 2 × 2
  name       command                           
  &lt;chr&gt;      &lt;chr&gt;                             
1 hello_file "\"_targets/user/data/hello.txt\""
2 hello      "readLines(hello_file)"           </code></pre>
</div>
<p>Notice that even though we only specified one target in the pipeline
(<code>hello</code>, with <code>tar_file_read()</code>), the pipeline
actually includes <strong>two</strong> targets, <code>hello_file</code>
and <code>hello</code>.</p>
<p>That is because <code>tar_file_read()</code> is a special function
called a <strong>target factory</strong>, so-called because it makes
<strong>multiple</strong> targets at once. One of the main purposes of
the <code>tarchetypes</code> package is to provide target factories to
make writing pipelines easier and less error-prone.</p>
</section><section id="non-standard-evaluation"><h2 class="section-heading">Non-standard evaluation<a class="anchor" aria-label="anchor" href="#non-standard-evaluation"></a>
</h2>
<hr class="half-width">
<p>What is the deal with the <code>!!.x</code>? That may look unfamiliar
even if you are used to using R. It is known as “non-standard
evaluation,” and gets used in some special contexts. We don’t have time
to go into the details now, but just remember that you will need to use
this special notation with <code>tar_file_read()</code>. If you forget
how to write it (this happens frequently!) look at the examples in the
help file by running <code>?tar_file_read</code>.</p>
</section><section id="other-data-loading-functions"><h2 class="section-heading">Other data loading functions<a class="anchor" aria-label="anchor" href="#other-data-loading-functions"></a>
</h2>
<hr class="half-width">
<p>Although we used <code>readLines()</code> as an example here, you can
use the same pattern for other functions that load data from external
files, such as <code>readr::read_csv()</code>,
<code>xlsx::read_excel()</code>, and others (for example,
<code>read_csv(!!.x)</code>, <code>read_excel(!!.x)</code>, etc.).</p>
<p>This is generally recommended so that your pipeline stays up to date
with your input data.</p>
<div id="challenge-use-tar_file_read-with-the-penguins-example" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-use-tar_file_read-with-the-penguins-example" class="callout-inner">
<h3 class="callout-title">Challenge: Use <code>tar_file_read()</code>
with the penguins example<a class="anchor" aria-label="anchor" href="#challenge-use-tar_file_read-with-the-penguins-example"></a>
</h3>
<div class="callout-content">
<p>We didn’t know about <code>tar_file_read()</code> yet when we started
on the penguins bill analysis.</p>
<p>How can you use <code>tar_file_read()</code> to load the CSV file
while tracking its contents?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target penguins_data_raw_file
• built target penguins_data_raw_file [0.003 seconds]
• start target penguins_data_raw
• built target penguins_data_raw [0.327 seconds]
• start target penguins_data
• built target penguins_data [0.022 seconds]
• end pipeline [0.466 seconds]</code></pre>
</div>
</div>
</div>
</div>
</div>
</section><section id="writing-out-data"><h2 class="section-heading">Writing out data<a class="anchor" aria-label="anchor" href="#writing-out-data"></a>
</h2>
<hr class="half-width">
<p>Writing to files is similar to loading in files: we will use the
<code>tar_file()</code> function. There is one important caveat: in this
case, the second argument of <code>tar_file()</code> (the command to
build the target) <strong>must return the path to the file</strong>. Not
all functions that write files do this (some return nothing; these treat
the output file is a side-effect of running the function), so you may
need to define a custom function that writes out the file and then
returns its path.</p>
<p>Let’s do this for <code>writeLines()</code>, the R function that
writes character data to a file. Normally, its output would be
<code>NULL</code> (nothing), as we can see here:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">writeLines</span><span class="op">(</span><span class="st">"some text"</span>, <span class="st">"test.txt"</span><span class="op">)</span></span>
<span><span class="va">x</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code><span><span class="cn">NULL</span></span></code></pre>
</div>
<p>Here is our modified function that writes character data to a file
and returns the name of the file (the <code>...</code> means “pass the
rest of these arguments to <code>writeLines()</code>”):</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">write_lines_file</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">text</span>, <span class="va">file</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">writeLines</span><span class="op">(</span>text <span class="op">=</span> <span class="va">text</span>, con <span class="op">=</span> <span class="va">file</span>, <span class="va">...</span><span class="op">)</span></span>
<span>  <span class="va">file</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Let’s try it out:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu">write_lines_file</span><span class="op">(</span><span class="st">"some text"</span>, <span class="st">"test.txt"</span><span class="op">)</span></span>
<span><span class="va">x</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>[1] "test.txt"</code></pre>
</div>
<p>We can now use this in a pipeline. For example let’s change the text
to upper case then write it out again:</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">hello</span>,</span>
<span>    <span class="st">"_targets/user/data/hello.txt"</span>,</span>
<span>    <span class="fu">readLines</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  hello_caps <span class="op">=</span> <span class="fu">toupper</span><span class="op">(</span><span class="va">hello</span><span class="op">)</span>,</span>
<span>  <span class="fu">tar_file</span><span class="op">(</span></span>
<span>    <span class="va">hello_caps_out</span>,</span>
<span>    <span class="fu">write_lines_file</span><span class="op">(</span><span class="va">hello_caps</span>, <span class="st">"_targets/user/results/hello_caps.txt"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target hello_file
• built target hello_file [0.002 seconds]
• start target hello
• built target hello [0.001 seconds]
• start target hello_caps
• built target hello_caps [0 seconds]
• start target hello_caps_out
• built target hello_caps_out [0 seconds]
• end pipeline [0.116 seconds]</code></pre>
</div>
<p>Take a look at <code>hello_caps.txt</code> in the
<code>results</code> folder and verify it is as you expect.</p>
<div id="challenge-what-happens-to-file-output-if-its-modified" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-what-happens-to-file-output-if-its-modified" class="callout-inner">
<h3 class="callout-title">Challenge: What happens to file output if its
modified?<a class="anchor" aria-label="anchor" href="#challenge-what-happens-to-file-output-if-its-modified"></a>
</h3>
<div class="callout-content">
<p>Delete or change the contents of <code>hello_caps.txt</code> in the
<code>results</code> folder. What do you think will happen when you run
<code>tar_make()</code> again? Try it and see.</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p><code>targets</code> detects that <code>hello_caps_out</code> has
changed (is “invalidated”), and re-runs the code to make it, thus
writing out <code>hello_caps.txt</code> to <code>results</code>
again.</p>
<p>So this way of writing out results makes your pipeline more robust:
we have a guarantee that the contents of the file in
<code>results</code> are generated solely by the code in your plan.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>
<code>tarchetypes::tar_file()</code> tracks the contents of a
file</li>
<li>Use <code>tarchetypes::tar_file_read()</code> in combination with
data loading functions like <code>read_csv()</code> to keep the pipeline
in sync with your input data</li>
<li>Use <code>tarchetypes::tar_file()</code> in combination with a
function that writes to a file and returns its path to write out
data</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section><section id="aio-branch"><p>Content from <a href="branch.html">Branching</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/branch.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we specify many targets without typing everything out?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Be able to specify targets using branching</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to use branching</p>
</div>
</div>
</div>
</div>
<section id="why-branching"><h2 class="section-heading">Why branching?<a class="anchor" aria-label="anchor" href="#why-branching"></a>
</h2>
<hr class="half-width">
<p>One of the major strengths of <code>targets</code> is the ability to
define many targets from a single line of code (“branching”). This not
only saves you typing, it also <strong>reduces the risk of
errors</strong> since there is less chance of making a typo.</p>
</section><section id="types-of-branching"><h2 class="section-heading">Types of branching<a class="anchor" aria-label="anchor" href="#types-of-branching"></a>
</h2>
<hr class="half-width">
<p>There are two types of branching, <strong>dynamic branching</strong>
and <strong>static branching</strong>. “Branching” refers to the idea
that you can provide a single specification for how to make targets (the
“pattern”), and <code>targets</code> generates multiple targets from it
(“branches”). “Dynamic” means that the branches that result from the
pattern do not have to be defined ahead of time—they are a dynamic
result of the code.</p>
<p>In this workshop, we will only cover dynamic branching since it is
generally easier to write (static branching requires use of <a href="https://books.ropensci.org/targets/static.html#metaprogramming" class="external-link">meta-programming</a>,
an advanced topic). For more information about each and when you might
want to use one or the other (or some combination of the two), <a href="https://books.ropensci.org/targets/dynamic.html" class="external-link">see the
<code>targets</code> package manual</a>.</p>
</section><section id="example-without-branching"><h2 class="section-heading">Example without branching<a class="anchor" aria-label="anchor" href="#example-without-branching"></a>
</h2>
<hr class="half-width">
<p>To see how this works, let’s continue our analysis of the
<code>palmerpenguins</code> dataset.</p>
<p><strong>Our hypothesis is that bill depth decreases with bill
length.</strong> We will test this hypothesis with a linear model.</p>
<p>For example, this is a model of bill depth dependent on bill
length:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">lm</span><span class="op">(</span><span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span></code></pre>
</div>
<p>We can add this to our pipeline. We will call it the
<code>combined_model</code> because it combines all the species together
without distinction:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build model</span></span>
<span>  combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_data_raw_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
• start target combined_model
• built target combined_model [0.091 seconds]
• end pipeline [0.208 seconds]</code></pre>
</div>
<p>Let’s have a look at the model. We will use the <code>glance()</code>
function from the <code>broom</code> package. Unlike base R
<code>summary()</code>, this function returns output as a tibble (the
tidyverse equivalent of a dataframe), which as we will see later is
quite useful for downstream analyses.</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">broom</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_load</span><span class="op">(</span><span class="va">combined_model</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">glance</span><span class="op">(</span><span class="va">combined_model</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt;
1    0.0552        0.0525  1.92      19.9 0.0000112     1  -708. 1422. 1433.    1256.         340   342</code></pre>
</div>
<p>Notice the small <em>P</em>-value. This seems to indicate that the
model is highly significant.</p>
<p>But wait a moment… is this really an appropriate model? Recall that
there are three species of penguins in the dataset. It is possible that
the relationship between bill depth and length <strong>varies by
species</strong>.</p>
<p>We should probably test some alternative models. These could include
models that add a parameter for species, or add an interaction effect
between species and bill length.</p>
<p>Now our workflow is getting more complicated. This is what a workflow
for such an analysis might look like <strong>without branching</strong>
(make sure to add <code><a href="https://broom.tidymodels.org/" class="external-link">library(broom)</a></code> to
<code>packages.R</code>):</p>
<div class="codewrapper sourceCode" id="cb6">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>  species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>  interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  combined_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">combined_model</span><span class="op">)</span>,</span>
<span>  species_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">species_model</span><span class="op">)</span>,</span>
<span>  interaction_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">interaction_model</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_data_raw_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
✔ skip target combined_model
• start target interaction_model
• built target interaction_model [0.006 seconds]
• start target species_model
• built target species_model [0.002 seconds]
• start target combined_summary
• built target combined_summary [0.01 seconds]
• start target interaction_summary
• built target interaction_summary [0.004 seconds]
• start target species_summary
• built target species_summary [0.004 seconds]
• end pipeline [0.235 seconds]</code></pre>
</div>
<p>Let’s look at the summary of one of the models:</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_read</span><span class="op">(</span><span class="va">species_summary</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt;
1     0.769         0.767 0.953      375. 3.65e-107     3  -467.  944.  963.     307.         338   342</code></pre>
</div>
<p>So this way of writing the pipeline works, but is repetitive: we have
to call <code>glance()</code> each time we want to obtain summary
statistics for each model. Furthermore, each summary target
(<code>combined_summary</code>, etc.) is explicitly named and typed out
manually. It would be fairly easy to make a typo and end up with the
wrong model being summarized.</p>
</section><section id="example-with-branching"><h2 class="section-heading">Example with branching<a class="anchor" aria-label="anchor" href="#example-with-branching"></a>
</h2>
<hr class="half-width">
<div class="section level3">
<h3 id="first-attempt">First attempt<a class="anchor" aria-label="anchor" href="#first-attempt"></a>
</h3>
<p>Let’s see how to write the same plan using <strong>dynamic
branching</strong>:</p>
<div class="codewrapper sourceCode" id="cb10">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance</span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>What is going on here?</p>
<p>First, let’s look at the messages provided by
<code>tar_make()</code>.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_data_raw_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
• start target models
• built target models [0.008 seconds]
• start branch model_summaries_5ad4cec5
• built branch model_summaries_5ad4cec5 [0.01 seconds]
• start branch model_summaries_c73912d5
• built branch model_summaries_c73912d5 [0.004 seconds]
• start branch model_summaries_91696941
• built branch model_summaries_91696941 [0.004 seconds]
• built pattern model_summaries
• end pipeline [0.389 seconds]</code></pre>
</div>
<p>There is a series of smaller targets (branches) that are each named
like model_summaries_5ad4cec5, then one overall
<code>model_summaries</code> target. That is the result of specifying
targets using branching: each of the smaller targets are the “branches”
that comprise the overall target. Since <code>targets</code> has no way
of knowing ahead of time how many branches there will be or what they
represent, it names each one using this series of numbers and letters
(the “hash”). <code>targets</code> builds each branch one at a time,
then combines them into the overall target.</p>
<p>Next, let’s look in more detail about how the workflow is set up,
starting with how we defined the models:</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build models</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu">list</span><span class="op">(</span></span>
<span>  combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>  species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>  interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Unlike the non-branching version, we defined the models <strong>in a
list</strong> (instead of one target per model). This is because dynamic
branching is similar to the <code>base::apply()</code> or <a href="https://purrr.tidyverse.org/reference/map.html" class="external-link"><code>purrrr::map()</code></a>
method of looping: it applies a function to each element of a list. So
we need to prepare the input for looping as a list.</p>
<p>Next, take a look at the command to build the target
<code>model_summaries</code>.</p>
<div class="codewrapper sourceCode" id="cb13">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get model summaries</span></span>
<span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">model_summaries</span>,</span>
<span>  <span class="fu">glance</span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>As before, the first argument is the name of the target to build, and
the second is the command to build it.</p>
<p>Here, we apply the <code>glance()</code> function to each element of
<code>models</code> (the <code>[[1]]</code> is necessary because when
the function gets applied, each element is actually a nested list, and
we need to remove one layer of nesting).</p>
<p>Finally, there is an argument we haven’t seen before,
<code>pattern</code>, which indicates that this target should be built
using dynamic branching. <code>map</code> means to apply the command to
each element of the input list (<code>models</code>) sequentially.</p>
<p>Now that we understand how the branching workflow is constructed,
let’s inspect the output:</p>
<div class="codewrapper sourceCode" id="cb14">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_read</span><span class="op">(</span><span class="va">model_summaries</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 3 × 12
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt;
1    0.0552        0.0525 1.92       19.9 1.12e-  5     1  -708. 1422. 1433.    1256.         340   342
2    0.769         0.767  0.953     375.  3.65e-107     3  -467.  944.  963.     307.         338   342
3    0.770         0.766  0.955     225.  8.52e-105     5  -466.  947.  974.     306.         336   342</code></pre>
</div>
<p>The model summary statistics are all included in a single
dataframe.</p>
<p>But there’s one problem: <strong>we can’t tell which row came from
which model!</strong> It would be unwise to assume that they are in the
same order as the list of models.</p>
<p>This is due to the way dynamic branching works: by default, there is
no information about the provenance of each target preserved in the
output.</p>
<p>How can we fix this?</p>
</div>
<div class="section level3">
<h3 id="second-attempt">Second attempt<a class="anchor" aria-label="anchor" href="#second-attempt"></a>
</h3>
<p>The key to obtaining useful output from branching pipelines is to
include the necessary information in the output of each individual
branch. Here, we want to know the kind of model that corresponds to each
row of the model summaries. To do that, we need to write a
<strong>custom function</strong>. You will need to write custom
functions frequently when using <code>targets</code>, so it’s good to
get used to it!</p>
<p>Here is the function. Save this in <code>R/functions.R</code>:</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance_with_mod_name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_name</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_in_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">glance</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>model_name <span class="op">=</span> <span class="va">model_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Our new pipeline looks almost the same as before, but this time we
use the custom function instead of <code>glance()</code>.</p>
<div class="codewrapper sourceCode" id="cb17">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>✔ skip target penguins_data_raw_file
✔ skip target penguins_data_raw
✔ skip target penguins_data
✔ skip target models
• start branch model_summaries_5ad4cec5
• built branch model_summaries_5ad4cec5 [0.019 seconds]
• start branch model_summaries_c73912d5
• built branch model_summaries_c73912d5 [0.009 seconds]
• start branch model_summaries_91696941
• built branch model_summaries_91696941 [0.005 seconds]
• built pattern model_summaries
• end pipeline [0.395 seconds]</code></pre>
</div>
<p>And this time, when we load the <code>model_summaries</code>, we can
tell which model corresponds to which row (you may need to scroll to the
right to see it).</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 3 × 13
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs model_name       
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt; &lt;chr&gt;            
1    0.0552        0.0525 1.92       19.9 1.12e-  5     1  -708. 1422. 1433.    1256.         340   342 combined_model   
2    0.769         0.767  0.953     375.  3.65e-107     3  -467.  944.  963.     307.         338   342 species_model    
3    0.770         0.766  0.955     225.  8.52e-105     5  -466.  947.  974.     306.         336   342 interaction_model</code></pre>
</div>
<p>Next we will add one more target, a prediction of bill depth based on
each model. These will be needed for plotting the models in the report.
Such a prediction can be obtained with the <code>augment()</code>
function of the <code>broom</code> package.</p>
<div class="codewrapper sourceCode" id="cb20">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_load</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span><span class="fu">augment</span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 342 × 8
   bill_depth_mm bill_length_mm .fitted .resid    .hat .sigma   .cooksd .std.resid
           &lt;dbl&gt;          &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
 1          18.7           39.1    17.6  1.14  0.00521   1.92 0.000924      0.594 
 2          17.4           39.5    17.5 -0.127 0.00485   1.93 0.0000107    -0.0663
 3          18             40.3    17.5  0.541 0.00421   1.92 0.000168      0.282 
 4          19.3           36.7    17.8  1.53  0.00806   1.92 0.00261       0.802 
 5          20.6           39.3    17.5  3.06  0.00503   1.92 0.00641       1.59  
 6          17.8           38.9    17.6  0.222 0.00541   1.93 0.0000364     0.116 
 7          19.6           39.2    17.6  2.05  0.00512   1.92 0.00293       1.07  
 8          18.1           34.1    18.0  0.114 0.0124    1.93 0.0000223     0.0595
 9          20.2           42      17.3  2.89  0.00329   1.92 0.00373       1.50  
10          17.1           37.8    17.7 -0.572 0.00661   1.92 0.000296     -0.298 
# ℹ 332 more rows</code></pre>
</div>
<div id="challenge-add-model-predictions-to-the-workflow" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-add-model-predictions-to-the-workflow" class="callout-inner">
<h3 class="callout-title">Challenge: Add model predictions to the
workflow<a class="anchor" aria-label="anchor" href="#challenge-add-model-predictions-to-the-workflow"></a>
</h3>
<div class="callout-content">
<p>Can you add the model predictions using <code>augment()</code>? You
will need to define a custom function just like we did for
<code>glance()</code>.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<p>Define the new function as <code>augment_with_mod_name()</code>. It
is the same as <code>glance_with_mod_name()</code>, but use
<code>augment()</code> instead of <code>glance()</code>:</p>
<div class="codewrapper sourceCode" id="cb22">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">augment_with_mod_name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_name</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_in_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">augment</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>model_name <span class="op">=</span> <span class="va">model_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Add the step to the workflow:</p>
<div class="codewrapper sourceCode" id="cb23">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model predictions</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_predictions</span>,</span>
<span>    <span class="fu">augment_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="best-practices-for-branching" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="best-practices-for-branching" class="callout-inner">
<h3 class="callout-title">Best practices for branching<a class="anchor" aria-label="anchor" href="#best-practices-for-branching"></a>
</h3>
<div class="callout-content">
<p>Dynamic branching is designed to work well with
<strong>dataframes</strong> (tibbles).</p>
<p>So if possible, write your custom functions to accept dataframes as
input and return them as output, and always include any necessary
metadata as a column or columns.</p>
</div>
</div>
</div>
<div id="challenge-what-other-kinds-of-patterns-are-there" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-what-other-kinds-of-patterns-are-there" class="callout-inner">
<h3 class="callout-title">Challenge: What other kinds of patterns are
there?<a class="anchor" aria-label="anchor" href="#challenge-what-other-kinds-of-patterns-are-there"></a>
</h3>
<div class="callout-content">
<p>So far, we have only used a single function in conjunction with the
<code>pattern</code> argument, <code>map()</code>, which applies the
function to each element of its input in sequence.</p>
<p>Can you think of any other ways you might want to apply a branching
pattern?</p>
</div>
</div>
</div>
<div id="accordionSolution2" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution2" aria-expanded="false" aria-controls="collapseSolution2">
  <h4 class="accordion-header" id="headingSolution2">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution2" class="accordion-collapse collapse" data-bs-parent="#accordionSolution2" aria-labelledby="headingSolution2">
<div class="accordion-body">
<p>Some other ways of applying branching patterns include:</p>
<ul>
<li>crossing: one branch per combination of elements
(<code>cross()</code> function)</li>
<li>slicing: one branch for each of a manually selected set of elements
(<code>slice()</code> function)</li>
<li>sampling: one branch for each of a randomly selected set of elements
(<code>sample()</code> function)</li>
</ul>
<p>You can <a href="https://books.ropensci.org/targets/dynamic.html#patterns" class="external-link">find out
more about different branching patterns in the <code>targets</code>
manual</a>.</p>
</div>
</div>
</div>
</div>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Dynamic branching creates multiple targets with a single
command</li>
<li>You usually need to write custom functions so that the output of the
branches includes necessary metadata</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></section><section id="aio-parallel"><p>Content from <a href="parallel.html">Parallel Processing</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/parallel.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we build targets in parallel?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Be able to build targets in parallel</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to use parallel processing</p>
</div>
</div>
</div>
</div>
<p>Once a pipeline starts to include many targets, you may want to think
about parallel processing. This takes advantage of multiple processors
in your computer to build multiple targets at the same time.</p>
<div id="when-to-use-parallel-processing" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="when-to-use-parallel-processing" class="callout-inner">
<h3 class="callout-title">When to use parallel processing<a class="anchor" aria-label="anchor" href="#when-to-use-parallel-processing"></a>
</h3>
<div class="callout-content">
<p>Parallel processing should only be used if your workflow has
independent tasks—if your workflow only consists of a linear sequence of
targets, then there is nothing to parallelize. Most workflows that use
branching can benefit from parallelism.</p>
</div>
</div>
</div>
<p><code>targets</code> includes support for high-performance computing,
cloud computing, and various parallel backends. Here, we assume you are
running this analysis on a laptop and so will use a relatively simple
backend. If you are interested in high-performance computing, <a href="https://books.ropensci.org/targets/hpc.html" class="external-link">see the
<code>targets</code> manual</a>.</p>
<div class="section level3">
<h3 id="install-r-packages-for-parallel-computing">Install R packages for parallel computing<a class="anchor" aria-label="anchor" href="#install-r-packages-for-parallel-computing"></a>
</h3>
<p>For this demo, we will use the new <a href="https://wlandau.github.io/crew/" class="external-link"><code>crew</code>
backend</a>.</p>
<div id="install-required-packages" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="install-required-packages" class="callout-inner">
<h3 class="callout-title">Install required packages<a class="anchor" aria-label="anchor" href="#install-required-packages"></a>
</h3>
<div class="callout-content">
<p>You will need to install several packages to use the
<code>crew</code> backend:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"nanonext"</span>, repos <span class="op">=</span> <span class="st">"https://shikokuchuo.r-universe.dev"</span><span class="op">)</span></span>
<span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"mirai"</span>, repos <span class="op">=</span> <span class="st">"https://shikokuchuo.r-universe.dev"</span><span class="op">)</span></span>
<span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"crew"</span>, type <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="set-up-workflow">Set up workflow<a class="anchor" aria-label="anchor" href="#set-up-workflow"></a>
</h3>
<p>To enable parallel processing with <code>crew</code> you only need to
load the <code>crew</code> package, then tell <code>targets</code> to
use it using <code>tar_option_set</code>. Specifically, the following
lines enable crew, and tells it to use 2 parallel workers. You can
increase this number on more powerful machines:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">crew</span><span class="op">)</span></span>
<span><span class="fu">tar_option_set</span><span class="op">(</span></span>
<span>  controller <span class="op">=</span> <span class="fu">crew_controller_local</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Make these changes to the penguins analysis. It should now look like
this:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We just added this!</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">crew</span><span class="op">)</span></span>
<span><span class="fu">tar_option_set</span><span class="op">(</span></span>
<span>  controller <span class="op">=</span> <span class="fu">crew_controller_local</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model predictions</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_predictions</span>,</span>
<span>    <span class="fu">augment_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>There is still one more thing we need to modify only for the purposes
of this demo: if we ran the analysis in parallel now, you wouldn’t
notice any difference in compute time because the functions are so
fast.</p>
<p>So let’s make “slow” versions of <code>glance_with_mod_name()</code>
and <code>augment_with_mod_name()</code> using the
<code>Sys.sleep()</code> function, which just tells the computer to wait
some number of seconds. This will simulate a long-running computation
and enable us to see the difference between running sequentially and in
parallel.</p>
<p>Add these functions to <code>functions.R</code> (you can copy-paste
the original ones, then modify them):</p>
<div class="codewrapper sourceCode" id="cb4">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance_with_mod_name_slow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">Sys.sleep</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">model_name</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_in_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">broom</span><span class="fu">::</span><span class="fu">glance</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>model_name <span class="op">=</span> <span class="va">model_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">augment_with_mod_name_slow</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">Sys.sleep</span><span class="op">(</span><span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">model_name</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_in_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">broom</span><span class="fu">::</span><span class="fu">augment</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>model_name <span class="op">=</span> <span class="va">model_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Then, change the plan to use the “slow” version of the functions:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">crew</span><span class="op">)</span></span>
<span><span class="fu">tar_option_set</span><span class="op">(</span></span>
<span>  controller <span class="op">=</span> <span class="fu">crew_controller_local</span><span class="op">(</span>workers <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name_slow</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model predictions</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_predictions</span>,</span>
<span>    <span class="fu">augment_with_mod_name_slow</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Finally, run the pipeline with <code>tar_make()</code> as normal.</p>
<div class="codewrapper">
<h3 class="code-label">ERROR<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="error" tabindex="0"><code>Error:
! Error running targets::tar_make()
  Error messages: targets::tar_meta(fields = error, complete_only = TRUE)
  Debugging guide: https://books.ropensci.org/targets/debugging.html
  How to ask for help: https://books.ropensci.org/targets/help.html
  Last error: there is no package called ‘crew’</code></pre>
</div>
<p>Notice that although the time required to build each individual
target is about 4 seconds, the total time to run the entire workflow is
less than the sum of the individual target times! That is proof that
processes are running in parallel <strong>and saving you
time</strong>.</p>
<p>The unique and powerful thing about targets is that <strong>we did
not need to change our custom function to run it in parallel</strong>.
We only adjusted <em>the workflow</em>. This means it is relatively easy
to refactor (modify) a workflow for running sequentially locally or
running in parallel in a high-performance context.</p>
<p>Now that we have demonstrated how this works, you can change your
analysis plan back to the original versions of the functions you
wrote.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>Dynamic branching creates multiple targets with a single
command</li>
<li>You usually need to write custom functions so that the output of the
branches includes necessary metadata</li>
<li>Parallel computing works at the level of the workflow, not the
function</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div></section><section id="aio-quarto"><p>Content from <a href="quarto.html">Reproducible Reports with Quarto</a></p>
<hr>
<p> Last updated on 2023-08-15 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/quarto.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
<p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
<div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>
<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul>
<li>How can we create reproducible reports?</li>
</ul>
</div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul>
<li>Be able to generate a report using <code>targets</code>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" data-bs-parent="#accordionInstructor1" aria-labelledby="headingInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to write reports with Quarto</p>
</div>
</div>
</div>
</div>
<section id="copy-paste-vs.-dynamic-documents"><h2 class="section-heading">Copy-paste vs. dynamic documents<a class="anchor" aria-label="anchor" href="#copy-paste-vs.-dynamic-documents"></a>
</h2>
<hr class="half-width">
<p>Typically, you will want to communicate the results of a data
analysis to a broader audience.</p>
<p>You may have done this before by copying and pasting statistics,
plots, and other results into a text document or presentation. This may
be fine if you only ever do the analysis once. But that is rarely the
case—it is much more likely that you will tweak parts of the analysis or
add new data and re-run your pipeline. With the copy-paste method, you’d
have to remember what results changed and manually make sure everything
is up-to-date. This is a perilous exercise!</p>
<p>Fortunately, <code>targets</code> provides functions for keeping a
document in sync with pipeline results, so you can avoid such pitfalls.
The main tool we will use to generate documents is
<strong>Quarto</strong>. Quarto can be used separately from
<code>targets</code> (and is a large topic on its own), but it also
happens to be an excellent way to dynamically generate reports with
<code>targets</code>.</p>
<p>Quarto allows you to insert the results of R code directly into your
documents so that there is no danger of copy-and-paste mistakes.
Furthermore, it can generate output from the same underlying script in
multiple formats including PDF, HTML, and Microsoft Word.</p>
<div id="install-quarto" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="install-quarto" class="callout-inner">
<h3 class="callout-title">Install Quarto<a class="anchor" aria-label="anchor" href="#install-quarto"></a>
</h3>
<div class="callout-content">
<p>If you haven’t done so already, you will need to <a href="https://quarto.org/docs/get-started/" class="external-link">install Quarto</a>, which is
separate from R.</p>
<p>You will also need to install the <code>quarto</code> R package with
<code>install.packages("quarto")</code>.</p>
</div>
</div>
</div>
</section><section id="about-quarto-files"><h2 class="section-heading">About Quarto files<a class="anchor" aria-label="anchor" href="#about-quarto-files"></a>
</h2>
<hr class="half-width">
<p><code>.qmd</code> or <code>.Qmd</code> is the extension for Quarto
files, and stands for “Quarto markdown”. Quarto files invert the normal
way of writing code and comments: in a typical R script, all text is
assumed to be R code, unless you preface it with a <code>#</code> to
show that it is a comment. In Quarto, all text is assumed to be prose,
and you use special notation to indicate which lines are R code to be
evaluated. Once the code is evaluated, the results get inserted into a
final, rendered document, which could be one of various formats.</p>
<figure><img src="https://ucsbcarpentry.github.io/Reproducible-Publications-with-RStudio-Quarto/fig/03-qmd-workflow.png" alt="" class="figure mx-auto d-block"><figcaption>Quarto workflow</figcaption></figure><p>We don’t have the time to go into the details of Quarto during this
lesson, but recommend the <a href="https://ucsbcarpentry.github.io/Reproducible-Publications-with-RStudio-Quarto/" class="external-link">“Introduction
to Reproducible Publications with RStudio” incubator (in-development)
lesson</a> for more on this topic.</p>
</section><section id="recommended-workflow"><h2 class="section-heading">Recommended workflow<a class="anchor" aria-label="anchor" href="#recommended-workflow"></a>
</h2>
<hr class="half-width">
<p>Dynamic documents like Quarto (or Rmarkdown, the predecessor to
Quarto) can actually be used to manage data analysis pipelines. But that
is not recommended because it doesn’t scale well and lacks the
sophisticated dependency tracking offered by <code>targets</code>.</p>
<p>Our suggested approach is to conduct the vast majority of data
analysis (in other words, the “heavy lifting”) in the
<code>targets</code> pipeline, then use the Quarto document to
<strong>summarize</strong> and <strong>plot</strong> the results.</p>
</section><section id="report-on-bill-size-in-penguins"><h2 class="section-heading">Report on bill size in penguins<a class="anchor" aria-label="anchor" href="#report-on-bill-size-in-penguins"></a>
</h2>
<hr class="half-width">
<p>Continuing our penguin bill size analysis, let’s write a report
evaluating each model.</p>
<p>To save time, the report is already available at <a href="https://github.com/joelnitta/penguins-targets" class="external-link uri">https://github.com/joelnitta/penguins-targets</a>.</p>
<p>Copy the <a href="https://raw.githubusercontent.com/joelnitta/penguins-targets/main/penguin_report.qmd" class="external-link">raw
code from here</a> and save it as a new file
<code>penguin_report.qmd</code> in your project folder (you may also be
able to right click in your browser and select “Save As”).</p>
<p>Then, add one more target to the pipeline using the
<code>tar_quarto()</code> function like this:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">source</span><span class="op">(</span><span class="st">"R/packages.R"</span><span class="op">)</span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load raw data</span></span>
<span>  <span class="fu">tar_file_read</span><span class="op">(</span></span>
<span>    <span class="va">penguins_data_raw</span>,</span>
<span>    <span class="fu">path_to_file</span><span class="op">(</span><span class="st">"penguins_raw.csv"</span><span class="op">)</span>,</span>
<span>    <span class="fu">read_csv</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Clean data</span></span>
<span>  penguins_data <span class="op">=</span> <span class="fu">clean_penguin_data</span><span class="op">(</span><span class="va">penguins_data_raw</span><span class="op">)</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguins_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model predictions</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_predictions</span>,</span>
<span>    <span class="fu">augment_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Generate report</span></span>
<span>  <span class="fu">tar_quarto</span><span class="op">(</span></span>
<span>    <span class="va">penguin_report</span>,</span>
<span>    path <span class="op">=</span> <span class="st">"penguin_report.qmd"</span>,</span>
<span>    quiet <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    packages <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="st">"targets"</span>, <span class="st">"tidyverse"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>The function to generate the report is <code>tar_quarto()</code>,
from the <code>tarchetypes</code> package.</p>
<p>As you can see, the “heavy” analysis of running the models is done in
the workflow, then there is a single call to render the report at the
end with <code>tar_quarto()</code>.</p>
</section><section id="how-does-targets-know-when-to-render-the-report"><h2 class="section-heading">How does <code>targets</code> know when to render the report?<a class="anchor" aria-label="anchor" href="#how-does-targets-know-when-to-render-the-report"></a>
</h2>
<hr class="half-width">
<p>It is not immediately apparent just from this how
<code>targets</code> knows to generate the report <strong>at the end of
the workflow</strong> (recall that build order is not determined by the
order of how targets are written in the workflow, but rather by their
dependencies). <code>penguin_report</code> does not appear to depend on
any of the other targets, since they do not show up in the
<code>tar_quarto()</code> call.</p>
<p>How does this work?</p>
<p>The answer lies <strong>inside</strong> the
<code>penguin_report.qmd</code> file. Let’s look at the start of the
file:</p>
<div class="codewrapper sourceCode" id="cb2">
<h3 class="code-label">MARKDOWN<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="sourceCode markdown" tabindex="0"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Simpson's Paradox in Palmer Penguins"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co">  echo: false</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="in">#| label: load</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="in">targets::tar_load(penguin_models_augmented)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="in">targets::tar_load(penguin_models_summary)</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="in">library(tidyverse)</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>This is an example analysis of penguins on the Palmer Archipelago in Antarctica.</span></code></pre>
</div>
<p>The lines in between <code>---</code> and <code>---</code> at the
very beginning are called the “YAML header”, and contain directions
about how to render the document.</p>
<p>The R code to be executed is specified by the lines between
<code>```{r}</code> and <code>```</code>. This is called a “code chunk”,
since it is a portion of code interspersed within prose text.</p>
<p>Take a closer look at the R code chunk. Notice the two calls to
<code>targets::tar_load()</code>. Do you remember what that function
does? It loads the targets built during the workflow.</p>
<p>Now things should make a bit more sense: <code>targets</code> knows
that the report depends on the targets built during the workflow,
<code>penguin_models_augmented</code> and
<code>penguin_models_summary</code>, <strong>because they are loaded in
the report with <code>tar_load()</code>.</strong></p>
</section><section id="generating-dynamic-content"><h2 class="section-heading">Generating dynamic content<a class="anchor" aria-label="anchor" href="#generating-dynamic-content"></a>
</h2>
<hr class="half-width">
<p>The call to <code>tar_load()</code> at the start of
<code>penguin_report.qmd</code> is really the key to generating an
up-to-date report—once those are loaded from the workflow, we know that
they are in sync with the data, and can use them to produce “polished”
text and plots.</p>
<div id="challenge-spot-the-dynamic-contents" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-spot-the-dynamic-contents" class="callout-inner">
<h3 class="callout-title">Challenge: Spot the dynamic contents<a class="anchor" aria-label="anchor" href="#challenge-spot-the-dynamic-contents"></a>
</h3>
<div class="callout-content">
<p>Read through <code>penguin_report.qmd</code> and try to find
instances where the targets built during the workflow
(<code>penguin_models_augmented</code> and
<code>penguin_models_summary</code>) are used to dynamically produce
text and plots.</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" data-bs-parent="#accordionSolution1" aria-labelledby="headingSolution1">
<div class="accordion-body">
<ul>
<li><p>In the code chunk labeled <code>results-stats</code>, statistics
from the models like <em>P</em>-value and adjusted <em>R</em> squared
are extracted, then inserted into the text with in-line code like
<code>`r mod_stats$combined$r.squared`</code>.</p></li>
<li><p>There are two figures, one for the combined model and one for the
separate model (code chunks labeled <code>fig-combined-plot</code> and
<code>fig-separate-plot</code>, respectively). These are built using the
points predicted from the model in
<code>penguin_models_augmented</code>.</p></li>
</ul>
</div>
</div>
</div>
</div>
<p>You should also interactively run the code in
<code>penguin_report.qmd</code> to better understand what is going on,
starting with <code>tar_load()</code>. In fact, that is how this report
was written: the code was run in an interactive session, and saved to
the report as it was gradually tweaked to obtain the desired
results.</p>
<p>The best way to learn this approach to generating reports is to
<strong>try it yourself</strong>.</p>
<p>So your final Challenge is to construct a <code>targets</code>
workflow using your own data and generate a report. Good luck!</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul>
<li>
<code>tarchetypes::tar_quarto()</code> is used to render Quarto
documents</li>
<li>You should load targets within the Quarto document using
<code>tar_load()</code> and <code>tar_read()</code>
</li>
<li>It is recommended to do heavy computations in the main targets
workflow, and lighter formatting and plot generation in the Quarto
document</li>
</ul>
</div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</section></section>
</div>
    </main>
</div>
<!-- END  : inst/pkgdown/templates/content-extra.html -->

      </div>
<!--/div.row-->
      		<footer class="row footer mx-md-3"><hr>
<div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/README.md" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/joelnitta/targets-workshop/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/joelnitta/targets-workshop/" class="external-link">Source</a></p>
				<p><a href="https://github.com/joelnitta/targets-workshop/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:joelnitta@gmail.com">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="../LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper" class="external-link">sandpaper (0.12.5)</a>,
        <a href="https://github.com/carpentries/pegboard/tree/0.5.3" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.17" class="external-link">varnish (0.2.17)</a>.</p>
			</div>
		</footer>
</div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://joelnitta.github.io/targets-workshop/instructor/aio.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "reproducibility, data, targets, R",
  "name": "All in One View",
  "creativeWorkStatus": "active",
  "url": "https://joelnitta.github.io/targets-workshop/instructor/aio.html",
  "identifier": "https://joelnitta.github.io/targets-workshop/instructor/aio.html",
  "dateCreated": "2023-07-31",
  "dateModified": "2023-08-22",
  "datePublished": "2023-08-22"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code -->
</body>
</html><!-- END:   inst/pkgdown/templates/layout.html-->

