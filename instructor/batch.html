<!DOCTYPE html>
<!-- START: inst/pkgdown/templates/layout.html --><!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><title>Introduction to targets: Batch and Parallel Processing</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" type="text/css" href="../assets/styles.css"><script src="../assets/scripts.js" type="text/javascript"></script><!-- mathjax --><script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      config: ["MMLorHTML.js"],
      jax: ["input/TeX","input/MathML","output/HTML-CSS","output/NativeMML", "output/PreviewHTML"],
      extensions: ["tex2jax.js","mml2jax.js","MathMenu.js","MathZoom.js", "fast-preview.js", "AssistiveMML.js", "a11y/accessibility-menu.js"],
      TeX: {
        extensions: ["AMSmath.js","AMSsymbols.js","noErrors.js","noUndefined.js"]
      },
      tex2jax: {
        inlineMath: [ ['$','$'], ['\\(', '\\)']],
        displayMath: [ ['$$','$$'], ['\\[', '\\]'] ],
        processEscapes: true
      }
    });
    </script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><!-- Responsive Favicon for The Carpentries --><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="manifest" href="../site.webmanifest"><link rel="mask-icon" href="../safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"></head><body>
    <header id="top" class="navbar navbar-expand-md navbar-light bg-white top-nav incubator"><a class="visually-hidden-focusable skip-link" href="#main-content">Skip to main content</a>
  <div class="container-fluid top-nav-container">
    <div class="col-md-6">
      <div class="large-logo">
        <img alt="Carpentries Incubator" src="../assets/images/incubator-logo.svg"><abbr class="icon" title="This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught." style="text-decoration: unset">
           
          <a href="https://cdh.carpentries.org/the-lesson-life-cycle.html#early-development-pre-alpha-through-alpha" class="external-link alert-link" style="color: #383838">Pre-Alpha
            <i aria-hidden="true" class="icon" data-feather="alert-octagon" style="color: #FF4955; border-radius: 5px"></i>
          </a>
          <span class="visually-hidden">This lesson is in the pre-alpha phase, which means that it is in early development, but has not yet been taught.</span>
        </abbr>
        
      </div>
    </div>
    <div class="selector-container ">
      
      
      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle bordered-button" type="button" id="dropdownMenu1" data-bs-toggle="dropdown" aria-expanded="false">
          <i aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View <i data-feather="chevron-down"></i>
        </button>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu1"><li><button class="dropdown-item" type="button" onclick="window.location.href='../batch.html';">Learner View</button></li>
        </ul></div>
    </div>
  </div>
  <hr></header><nav class="navbar navbar-expand-xl navbar-light bg-white bottom-nav incubator" aria-label="Main Navigation"><div class="container-fluid nav-container">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
      <span class="menu-title">Menu</span>
    </button>
    <div class="nav-logo">
      <img class="small-logo" alt="Carpentries Incubator" src="../assets/images/incubator-logo-sm.svg"></div>
    <div class="lesson-title-md">
      Introduction to targets
    </div>
    <div class="search-icon-sm">
      <!-- TODO: do not show until we have search
      <i role="img" aria-label="search button" data-feather="search"></i>
      -->
    </div>
    <div class="desktop-nav">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0"><li class="nav-item">
          <span class="lesson-title">
            Introduction to targets
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/key-points.html">Key Points</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/instructor-notes.html">Instructor Notes</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="../instructor/images.html">Extract All Images</a>
        </li>
        <li class="nav-item dropdown">
          <button class="nav-link dropdown-toggle" id="navbarDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            More <i data-feather="chevron-down"></i>
          </button>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdown"></ul></li>
      </ul></div>
    <form class="d-flex col-md-2 search-form">
      <fieldset disabled><input class="form-control me-2 searchbox" type="search" placeholder="Search" aria-label="Search"><button class="btn btn-outline-success tablet-search-button" type="submit">
          <i class="search-icon" data-feather="search" role="img" aria-label="search button"></i>
        </button>
      </fieldset></form>
  </div><!--/div.container-fluid -->
</nav><div class="col-md-12 mobile-title">
  Introduction to targets
</div>

<aside class="col-md-12 lesson-progress"><div style="width: 70%" class="percentage">
    70%
  </div>
  <div class="progress incubator">
    <div class="progress-bar incubator" role="progressbar" style="width: 70%" aria-valuenow="70" aria-label="Lesson Progress" aria-valuemin="0" aria-valuemax="100">
    </div>
  </div>
</aside><div class="container">
      <div class="row">
        <!-- START: inst/pkgdown/templates/navbar.html -->
  <div id="sidebar-col" class="col-lg-4">
    <div id="sidebar" class="sidebar">
      <nav aria-labelledby="flush-headingEleven"><button role="button" aria-label="close menu" alt="close menu" aria-expanded="true" aria-controls="sidebar" class="collapse-toggle"><i class="search-icon" data-feather="x" role="img"></i></button>
        <div class="sidebar-inner">
          <div class="row mobile-row">
            <div class="col">
              <div class="sidenav-view-selector">
                <div class="accordion accordion-flush" id="accordionFlush9">
                  <div class="accordion-item">
                    <h2 class="accordion-header" id="flush-headingNine">
                      <button class="accordion-button collapsed" id="instructor" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseNine" aria-expanded="false" aria-controls="flush-collapseNine">
                        <i id="eye" aria-hidden="true" class="icon" data-feather="eye"></i> Instructor View
                      </button>
                    </h2>
                    <div id="flush-collapseNine" class="accordion-collapse collapse" aria-labelledby="flush-headingNine" data-bs-parent="#accordionFlush2">
                      <div class="accordion-body">
                        <a href="../batch.html">Learner View</a>
                      </div>
                    </div>
                  </div><!--/div.accordion-item-->
                </div><!--/div.accordion-flush-->
              </div><!--div.sidenav-view-selector -->
            </div><!--/div.col -->
      
            <hr></div><!--/div.mobile-row -->

          <div class="accordion accordion-flush" id="accordionFlush11">
            <div class="accordion-item">

              <button id="chapters" class="accordion-button show" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseEleven" aria-expanded="false" aria-controls="flush-collapseEleven">
                <h2 class="accordion-header chapters" id="flush-headingEleven">
                  EPISODES
                </h2>
              </button>
              <div id="flush-collapseEleven" class="accordion-collapse show collapse" aria-labelledby="flush-headingEleven" data-bs-parent="#accordionFlush11">

                <div class="accordion-body">
                  <div class="accordion accordion-flush" id="accordionFlush1">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading1">
        <a href="index.html">Summary and Schedule</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush2">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading2">
        <a href="introduction.html">1. Introduction</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush3">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading3">
        <a href="basic-targets.html">2. First targets Workflow</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush4">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading4">
        <a href="cache.html">3. Loading Workflow Objects</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush5">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading5">
        <a href="lifecycle.html">4. The Workflow Lifecycle</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush6">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading6">
        <a href="organization.html">5. Best Practices for targets Project Organization</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush7">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading7">
        <a href="packages.html">6. Managing Packages</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush8">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading8">
        <a href="files.html">7. Working with External Files</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlushcurrent">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-headingcurrent">
      <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapsecurrent" aria-expanded="true" aria-controls="flush-collapsecurrent">
        <span class="visually-hidden">Current Chapter</span>
        <span class="current-chapter">
        Batch and Parallel Processing
        </span>
      </button>
    </div><!--/div.accordion-header-->
        
    <div id="flush-collapsecurrent" class="accordion-collapse collapse show" aria-labelledby="flush-headingcurrent" data-bs-parent="#accordionFlushcurrent">
      <div class="accordion-body">
        <ul><li><a href="#why-batch-and-parallel-processing">Why batch and parallel processing?</a></li>
<li><a href="#types-of-branching">Types of branching</a></li>
<li><a href="#example-without-branching">Example without branching</a></li>
<li><a href="#example-with-branching">Example with branching</a></li>
<li><a href="#parallel-processing">Parallel processing</a></li>
        </ul></div><!--/div.accordion-body-->
    </div><!--/div.accordion-collapse-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush10">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading10">
        <a href="quarto.html">9. Reproducible Reports with Quarto</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

<div class="accordion accordion-flush" id="accordionFlush11">
  <div class="accordion-item">
    <div class="accordion-header" id="flush-heading11">
        <a href="advanced.html">10. Advanced topics</a>
    </div><!--/div.accordion-header-->
        
  </div><!--/div.accordion-item-->
</div><!--/div.accordion-flush-->

                </div>
              </div>
            </div>

            <hr class="half-width"><div class="accordion accordion-flush resources" id="accordionFlush12">
              <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwelve">
                  <button class="accordion-button collapsed" id="resources" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwelve" aria-expanded="false" aria-controls="flush-collapseTwelve">
                    RESOURCES
                  </button>
                </h2>
                <div id="flush-collapseTwelve" class="accordion-collapse collapse" aria-labelledby="flush-headingTwelve" data-bs-parent="#accordionFlush12">
                  <div class="accordion-body">
                    <ul><li>
                        <a href="../instructor/key-points.html">Key Points</a>
                      </li>
                      <li>
                        <a href="../instructor/instructor-notes.html">Instructor Notes</a>
                      </li>
                      <li>
                        <a href="../instructor/images.html">Extract All Images</a>
                      </li>
                      
                    </ul></div>
                </div>
              </div>
            </div>
            <hr class="half-width resources"><a href="../instructor/aio.html">See all in one page</a>

            <hr class="d-none d-sm-block d-md-none"><div class="d-grid gap-1">
            
            </div>
          </div><!-- /div.accordion -->
        </div><!-- /div.sidebar-inner -->
      </nav></div><!-- /div.sidebar -->
  </div><!-- /div.sidebar-col -->
<!-- END:   inst/pkgdown/templates/navbar.html-->

        <!-- START: inst/pkgdown/templates/content-instructor.html -->
  <div class="col-xl-8 col-lg-12 primary-content">
    <nav class="lesson-content mx-md-4" aria-label="Previous and Next Chapter"><!-- content for small screens --><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/files.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/quarto.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/files.html" rel="prev"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous: Working with</a>
        <a class="chapter-link float-end" href="../instructor/quarto.html" rel="next">Next: Reproducible Reports... <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <hr></nav><main id="main-content" class="main-content"><div class="container lesson-content">
        <h1>Batch and Parallel Processing</h1>
        <p> Last updated on 2023-05-24 | 
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/batch.Rmd" class="external-link">Edit this page <i aria-hidden="true" data-feather="edit"></i></a></p>
        
        
        
        <p>Estimated time <i aria-hidden="true" data-feather="clock"></i> 12 minutes </p>
        
        <div class="text-end">
          <button role="button" aria-pressed="false" tabindex="0" id="expand-code" class="pull-right"> Expand All Solutions <i aria-hidden="true" data-feather="plus"></i></button>
        </div>

        

<div class="overview card">
<h2 class="card-header">Overview</h2>
<div class="row g-0">
<div class="col-md-4">
<div class="card-body">
<div class="inner">
<h3 class="card-title">Questions</h3>
<ul><li>How can we specify many targets without typing everything out?</li>
<li>How can we build targets in parallel?</li>
</ul></div>
</div>
</div>
<div class="col-md-8">
<div class="card-body">
<div class="inner bordered">
<h3 class="card-title">Objectives</h3>
<ul><li>Be able to specify targets using branching</li>
<li>Be able to build targets in parallel</li>
</ul></div>
</div>
</div>
</div>
</div>
<div id="accordionInstructor1" class="accordion instructor-note accordion-flush">
<div class="accordion-item">
<button class="accordion-button instructor-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInstructor1" aria-expanded="false" aria-controls="collapseInstructor1">
  <h3 class="accordion-header" id="headingInstructor1">
  <div class="note-square"><i aria-hidden="true" class="callout-icon" data-feather="edit-2"></i></div>
  Instructor Note
  </h3>
</button>
<div id="collapseInstructor1" class="accordion-collapse collapse" aria-labelledby="headingInstructor1" data-bs-parent="#accordionInstructor1">
<div class="accordion-body">
<p>Episode summary: Show how to use branching and parallel processing
(technically separate topics, but they go well together)</p>
</div>
</div>
</div>
</div>
<section id="why-batch-and-parallel-processing"><h2 class="section-heading">Why batch and parallel processing?<a class="anchor" aria-label="anchor" href="#why-batch-and-parallel-processing"></a>
</h2>
<hr class="half-width"><p>One of the major strengths of <code>targets</code> is the ability to
define many targets from a single line of code (batch processing). This
not only saves you typing, it also <strong>reduces the risk of
errors</strong> since there is less chance of making a typo.
Furthermore, it is related to another powerful feature:
<code>targets</code> can run multiple analyses in parallel (at the same
time), thereby <strong>making your analysis finish sooner</strong>.</p>
</section><section id="types-of-branching"><h2 class="section-heading">Types of branching<a class="anchor" aria-label="anchor" href="#types-of-branching"></a>
</h2>
<hr class="half-width"><p>Batching in <code>targets</code> is called “branching.” There are two
types of branching, <strong>dynamic branching</strong> and
<strong>static branching</strong>. “Branching” refers to the idea that
you can provide a single specification for how to make targets (the
“pattern”), and <code>targets</code> generates multiple targets from it
(“branches”). “Dynamic” means that the branches that result from the
pattern do not have to be defined ahead of time—they are a dynamic
result of the code.</p>
<p>In this workshop, we will only cover dynamic branching since it is
generally easier to write (static branching requires use of <a href="https://books.ropensci.org/targets/static.html#metaprogramming" class="external-link">meta-programming</a>,
an advanced topic). For more information about each and when you might
want to use one or the other (or some combination of the two), <a href="https://books.ropensci.org/targets/dynamic.html" class="external-link">see the
<code>targets</code> package manual</a>.</p>
</section><section id="example-without-branching"><h2 class="section-heading">Example without branching<a class="anchor" aria-label="anchor" href="#example-without-branching"></a>
</h2>
<hr class="half-width"><p>To see how this works, let’s use an example based on the
<code>palmerpenguins</code> dataset. Our hypothesis is that bill depth
decreases with bill length. We want to test this using several
alternative models. The models will either ignore species identity, add
a parameter for species, or add an interaction effect between species
and bill length.</p>
<p>This is what a workflow for such an analysis might look like
<strong>without branching</strong>:</p>
<div class="codewrapper sourceCode" id="cb1">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">broom</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load data from package</span></span>
<span>  penguin_data <span class="op">=</span> <span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>  species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>  interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  combined_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">combined_model</span><span class="op">)</span>,</span>
<span>  species_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">species_model</span><span class="op">)</span>,</span>
<span>  interaction_summary <span class="op">=</span> <span class="fu">glance</span><span class="op">(</span><span class="va">interaction_model</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target penguin_data
• built target penguin_data [0.003 seconds]
• start target combined_model
• built target combined_model [0.064 seconds]
• start target interaction_model
• built target interaction_model [0.002 seconds]
• start target species_model
• built target species_model [0.002 seconds]
• start target combined_summary
• built target combined_summary [0.079 seconds]
• start target interaction_summary
• built target interaction_summary [0.003 seconds]
• start target species_summary
• built target species_summary [0.003 seconds]
• end pipeline [0.253 seconds]</code></pre>
</div>
<p>It worked. Let’s check some of the model output:</p>
<div class="codewrapper sourceCode" id="cb3">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_read</span><span class="op">(</span><span class="va">combined_summary</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 1 × 12
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt;
1    0.0552        0.0525  1.92      19.9 0.0000112     1  -708. 1422. 1433.    1256.         340   342</code></pre>
</div>
<p>This way of writing the pipeline is repetitive: we have to call
<code>glance()</code> each time we want to obtain summary statistics for
each model. Furthermore, each summary target
(<code>combined_summary</code>, etc.) is explicitly named and typed out
manually. It would be fairly easy to make a typo and end up with the
wrong model being summarized.</p>
</section><section id="example-with-branching"><h2 class="section-heading">Example with branching<a class="anchor" aria-label="anchor" href="#example-with-branching"></a>
</h2>
<hr class="half-width"><div class="section level3">
<h3 id="first-attempt">First attempt<a class="anchor" aria-label="anchor" href="#first-attempt"></a></h3>
<p>Let’s see how to write the same plan using <strong>dynamic
branching</strong>:</p>
<div class="codewrapper sourceCode" id="cb5">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">broom</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load data from package</span></span>
<span>  penguin_data <span class="op">=</span> <span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance</span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>What is going on here?</p>
<p>First, let’s look at the messages provided by
<code>tar_make()</code>.</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target penguin_data
• built target penguin_data [0.002 seconds]
• start target models
• built target models [0.006 seconds]
• start branch model_summaries_ea786eaa
• built branch model_summaries_ea786eaa [0.007 seconds]
• start branch model_summaries_1c878f62
• built branch model_summaries_1c878f62 [0.003 seconds]
• start branch model_summaries_afef26b4
• built branch model_summaries_afef26b4 [0.003 seconds]
• built pattern model_summaries
• end pipeline [0.116 seconds]</code></pre>
</div>
<p>There is a series of smaller targets (branches) that are each named
like <code>model_summaries_f9795da2</code>, then one overall
<code>model_summaries</code> target. That is the result of specifying
targets using branching: each of the smaller targets are the “branches”
that comprise the overall target. Since <code>targets</code> has no way
of knowing ahead of time how many branches there will be or what they
represent, it names each one using this series of numbers and letters
(the “hash”). <code>targets</code> builds each branch one at a time,
then combines them into the overall target.</p>
<p>Next, let’s look in more detail about how the workflow is set up,
starting with how we defined the models:</p>
<div class="codewrapper sourceCode" id="cb7">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Build models</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu">list</span><span class="op">(</span></span>
<span>  combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>  species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>  interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>    <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Unlike the non-branching version, we defined the models <strong>in a
list</strong> (instead of one target per model). This is because dynamic
branching is similar to the <code>apply()</code> or <a href="https://purrr.tidyverse.org/reference/map.html" class="external-link"><code>purrrr::map()</code></a>
method of looping: it applies a function to each element of a list. So
we need to prepare the input for looping as a list.</p>
<p>Next, take a look at the command to build the target
<code>model_summaries</code>.</p>
<div class="codewrapper sourceCode" id="cb8">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get model summaries</span></span>
<span><span class="fu">tar_target</span><span class="op">(</span></span>
<span>  <span class="va">model_summaries</span>,</span>
<span>  <span class="fu">glance</span><span class="op">(</span><span class="va">models</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>As before, the first argument is the name of the target to build, and
the second is the command to build it.</p>
<p>Here, we apply the <code>glance()</code> function to each element of
<code>models</code> (the <code>[[1]]</code> is necessary because when
the function gets applied, each element is actually a nested list, and
we need to remove one layer of nesting).</p>
<p>Finally, there is an argument we haven’t seen before,
<code>pattern</code>, which indicates that this target should be built
using dynamic branching. <code>map</code> means to apply the command to
each element of the input list (<code>models</code>) sequentially.</p>
<p>Now that we understand how the branching workflow is constructed,
let’s inspect the output:</p>
<div class="codewrapper sourceCode" id="cb9">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">tar_read</span><span class="op">(</span><span class="va">model_summaries</span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 3 × 12
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt;
1    0.0552        0.0525 1.92       19.9 1.12e-  5     1  -708. 1422. 1433.    1256.         340   342
2    0.769         0.767  0.953     375.  3.65e-107     3  -467.  944.  963.     307.         338   342
3    0.770         0.766  0.955     225.  8.52e-105     5  -466.  947.  974.     306.         336   342</code></pre>
</div>
<p>The model summary statistics are all included in a single
dataframe.</p>
<p>But there’s one problem: <strong>we can’t tell which row came from
which model!</strong> It would be unwise to assume that they are in the
same order as the list of models.</p>
<p>This is due to the way dynamic branching works: by default, there is
no information about the provenance of each target preserved in the
output.</p>
<p>How can we fix this?</p>
</div>
<div class="section level3">
<h3 id="second-attempt">Second attempt<a class="anchor" aria-label="anchor" href="#second-attempt"></a></h3>
<p>The key to obtaining useful output from branching pipelines is to
include the necessary information in the output of each individual
branch. Here, we want to know the kind of model that corresponds to each
row of the model summaries. To do that, we need to write a
<strong>custom function</strong>. You will need to write custom
functions frequently when using <code>targets</code>, so it’s good to
get used to it!</p>
<p>Here is the function. Save this in <code>R/functions.R</code>:</p>
<div class="codewrapper sourceCode" id="cb11">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glance_with_mod_name</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">model_name</span> <span class="op">&lt;-</span> <span class="fu">names</span><span class="op">(</span><span class="va">model_in_list</span><span class="op">)</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">model_in_list</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="fu">broom</span><span class="fu">::</span><span class="fu">glance</span><span class="op">(</span><span class="va">model</span><span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>model_name <span class="op">=</span> <span class="va">model_name</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
</div>
<p>Our new pipeline looks almost the same as before, but this time we
use the custom function instead of <code>broom::glance()</code>.</p>
<div class="codewrapper sourceCode" id="cb12">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load data from package</span></span>
<span>  penguin_data <span class="op">=</span> <span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target penguin_data
• built target penguin_data [0.003 seconds]
• start target models
• built target models [0.013 seconds]
• start branch model_summaries_ea786eaa
• built branch model_summaries_ea786eaa [0.032 seconds]
• start branch model_summaries_1c878f62
• built branch model_summaries_1c878f62 [0.008 seconds]
• start branch model_summaries_afef26b4
• built branch model_summaries_afef26b4 [0.004 seconds]
• built pattern model_summaries
• end pipeline [0.194 seconds]</code></pre>
</div>
<p>And this time, when we load the <code>model_summaries</code>, we can
tell which model corresponds to which row (you may need to scroll to the
right to see it).</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code># A tibble: 3 × 13
  r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance df.residual  nobs model_name       
      &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt;       &lt;int&gt; &lt;int&gt; &lt;chr&gt;            
1    0.0552        0.0525 1.92       19.9 1.12e-  5     1  -708. 1422. 1433.    1256.         340   342 combined_model   
2    0.769         0.767  0.953     375.  3.65e-107     3  -467.  944.  963.     307.         338   342 species_model    
3    0.770         0.766  0.955     225.  8.52e-105     5  -466.  947.  974.     306.         336   342 interaction_model</code></pre>
</div>
<div id="best-practices-for-branching" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="best-practices-for-branching" class="callout-inner">
<h3 class="callout-title">Best practices for branching<a class="anchor" aria-label="anchor" href="#best-practices-for-branching"></a>
</h3>
<div class="callout-content">
<p>Dynamic branching is designed to work well with
<strong>dataframes</strong> (tibbles).</p>
<p>So if possible, write your custom functions to accept dataframes as
input and return them as output, and always include any necessary
metadata as a column or columns.</p>
</div>
</div>
</div>
<div id="challenge-what-other-kinds-of-patterns-are-there" class="callout challenge">
<div class="callout-square">
<i class="callout-icon" data-feather="zap"></i>
</div>
<div id="challenge-what-other-kinds-of-patterns-are-there" class="callout-inner">
<h3 class="callout-title">Challenge: What other kinds of patterns are
there?<a class="anchor" aria-label="anchor" href="#challenge-what-other-kinds-of-patterns-are-there"></a>
</h3>
<div class="callout-content">
<p>So far, we have only used a single function in conjunction with the
<code>pattern</code> argument, <code>map()</code>, which applies the
function to each element of its input in sequence.</p>
<p>Can you think of any other ways you might want to apply a branching
pattern?</p>
</div>
</div>
</div>
<div id="accordionSolution1" class="accordion challenge-accordion accordion-flush">
<div class="accordion-item">
<button class="accordion-button solution-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSolution1" aria-expanded="false" aria-controls="collapseSolution1">
  <h4 class="accordion-header" id="headingSolution1">
  Show me the solution
  </h4>
</button>
<div id="collapseSolution1" class="accordion-collapse collapse" aria-labelledby="headingSolution1" data-bs-parent="#accordionSolution1">
<div class="accordion-body">
<p>Some other ways of applying branching patterns include:</p>
<ul><li>crossing: one branch per combination of elements
(<code>cross()</code> function)</li>
<li>slicing: one branch for each of a manually selected set of elements
(<code>slice()</code> function)</li>
<li>sampling: one branch for each of a randomly selected set of elements
(<code>sample()</code> function)</li>
</ul><p>You can <a href="https://books.ropensci.org/targets/dynamic.html#patterns" class="external-link">find out
more about different branching patterns in the <code>targets</code>
manual</a>.</p>
</div>
</div>
</div>
</div>
</div>
</section><section id="parallel-processing"><h2 class="section-heading">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h2>
<hr class="half-width"><p>Once a pipeline starts to include many targets, you may want to think
about parallel processing. This takes advantage of multiple processors
in your computer to build multiple targets at the same time.</p>
<div id="when-to-use-parallel-computing" class="callout callout">
<div class="callout-square">
<i class="callout-icon" data-feather="bell"></i>
</div>
<div id="when-to-use-parallel-computing" class="callout-inner">
<h3 class="callout-title">When to use parallel computing<a class="anchor" aria-label="anchor" href="#when-to-use-parallel-computing"></a>
</h3>
<div class="callout-content">
<p>Parallel computing should only be used if your workflow has a
structure such that it makes sense—if your workflow only consists of a
linear sequence of targets, then there is nothing to parallelize.</p>
</div>
</div>
</div>
<p><code>targets</code> includes support for high-performance computing,
cloud computing, and various parallel backends. Here, we assume you are
running this analysis on a laptop and so will use a relatively simple
backend. If you are interested in high-performance computing, <a href="https://books.ropensci.org/targets/hpc.html" class="external-link">see the
<code>targets</code> manual</a>.</p>
<div class="section level3">
<h3 id="install-r-packages-for-parallel-computing">Install R packages for parallel computing<a class="anchor" aria-label="anchor" href="#install-r-packages-for-parallel-computing"></a></h3>
<p>For this demo, we will use the <a href="https://github.com/HenrikBengtsson/future" class="external-link"><code>future</code>
backend</a>.</p>
<div id="install-required-packages" class="callout prereq">
<div class="callout-square">
<i class="callout-icon" data-feather="check"></i>
</div>
<div id="install-required-packages" class="callout-inner">
<h3 class="callout-title">Install required packages<a class="anchor" aria-label="anchor" href="#install-required-packages"></a>
</h3>
<div class="callout-content">
<p>You will need to install several packages to use the
<code>future</code> backend:</p>
<div class="codewrapper sourceCode" id="cb15">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"future"</span><span class="op">)</span></span>
<span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"future.batchtools"</span><span class="op">)</span></span>
<span><span class="fu">install.packages</span><span class="op">(</span><span class="st">"future.callr"</span><span class="op">)</span></span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="section level3">
<h3 id="set-up-workflow">Set up workflow<a class="anchor" aria-label="anchor" href="#set-up-workflow"></a></h3>
<p>There are a few things you need to change to enable parallel
processing with <code>future</code>:</p>
<ul><li>Load the <code>future</code> and <code>future.callr</code>
packages</li>
<li>Add a line with <code>plan(callr)</code>
</li>
<li>When you run the pipeline, use
<code>tar_make_future(workers = 2)</code> instead of
<code>tar_make()</code>
</li>
</ul><p>Here, <code>workers = 2</code> is the number of processes to run in
parallel. You may increase this up to the number of cores available on
your machine.</p>
<p>To show how this works we will simulate a long(ish) running analysis
with the <code>Sys.sleep()</code> function, which just tells the
computer to wait some number of seconds.</p>
<div class="codewrapper sourceCode" id="cb16">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">future</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">future.callr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">callr</span><span class="op">)</span></span>
<span></span>
<span><span class="va">long_square</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">Sys.sleep</span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span>  <span class="va">data</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  some_data <span class="op">=</span> <span class="fu">c</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">data_squared</span>,</span>
<span>    <span class="fu">long_square</span><span class="op">(</span><span class="va">some_data</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">some_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<p>Here is the output when running with
<code>tar_make_future(workers = 2)</code>:</p>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>• start target some_data
• built target some_data [0.147 seconds]
• start branch data_squared_3ba31302
• start branch data_squared_880e1e2e
• built branch data_squared_3ba31302 [3.153 seconds]
• start branch data_squared_552eb2cc
• built branch data_squared_880e1e2e [3.155 seconds]
• start branch data_squared_92b840e1
• built branch data_squared_552eb2cc [3.155 seconds]
• built branch data_squared_92b840e1 [3.155 seconds]
• built pattern data_squared
• end pipeline [9.689 seconds]</code></pre>
</div>
<p>Notice that although the time required to build each individual
target is about 3 seconds, the total time to run the entire workflow is
less than the sum of the individual target times! That is proof that
processes are running in parallel <strong>and saving you
time</strong>.</p>
<p>The unique and powerful thing about targets is that <strong>we did
not need to change our custom function to run it in parallel</strong>.
We only adjusted <em>the workflow</em>. This means it is relatively easy
to refactor (modify) a workflow for running sequentially locally or
running in parallel in a high-performance context.</p>
<p>We can see this by applying parallel processing to a workflow that we
were previously running sequentially, the penguins analysis:</p>
<div class="codewrapper sourceCode" id="cb18">
<h3 class="code-label">R<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">library</span><span class="op">(</span><span class="va">targets</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tarchetypes</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">palmerpenguins</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">future</span><span class="op">)</span></span>
<span><span class="kw">library</span><span class="op">(</span><span class="va">future.callr</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">source</span><span class="op">(</span><span class="st">"R/functions.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plan</span><span class="op">(</span><span class="va">callr</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">tar_plan</span><span class="op">(</span></span>
<span>  <span class="co"># Load data from package</span></span>
<span>  penguin_data <span class="op">=</span> <span class="fu">palmerpenguins</span><span class="fu">::</span><span class="va">penguins</span>,</span>
<span>  <span class="co"># Build models</span></span>
<span>  models <span class="op">=</span> <span class="fu">list</span><span class="op">(</span></span>
<span>    combined_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    species_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">+</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span>,</span>
<span>    interaction_model <span class="op">=</span> <span class="fu">lm</span><span class="op">(</span></span>
<span>      <span class="va">bill_depth_mm</span> <span class="op">~</span> <span class="va">bill_length_mm</span> <span class="op">*</span> <span class="va">species</span>, data <span class="op">=</span> <span class="va">penguin_data</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="co"># Get model summaries</span></span>
<span>  <span class="fu">tar_target</span><span class="op">(</span></span>
<span>    <span class="va">model_summaries</span>,</span>
<span>    <span class="fu">glance_with_mod_name</span><span class="op">(</span><span class="va">models</span><span class="op">)</span>,</span>
<span>    pattern <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">models</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre>
</div>
<div class="codewrapper">
<h3 class="code-label">OUTPUT<i aria-hidden="true" data-feather="chevron-left"></i><i aria-hidden="true" data-feather="chevron-right"></i>
</h3>
<pre class="output" tabindex="0"><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.2     ✔ readr     2.1.4
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.2     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.1     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
• start target penguin_data
• built target penguin_data [0.627 seconds]
• start target models
• built target models [0.641 seconds]
• start branch model_summaries_ea786eaa
• start branch model_summaries_1c878f62
• built branch model_summaries_ea786eaa [0.665 seconds]
• start branch model_summaries_afef26b4
• built branch model_summaries_1c878f62 [0.675 seconds]
• built branch model_summaries_afef26b4 [0.665 seconds]
• built pattern model_summaries
• end pipeline [6.737 seconds]</code></pre>
</div>
<p>You won’t notice much difference since these computations run so
quickly, but this demonstrates how easy it is to make massive gains in
efficiency with your own real analysis by using parallel computing.</p>
<div id="keypoints1" class="callout keypoints">
<div class="callout-square">
<i class="callout-icon" data-feather="key"></i>
</div>
<div class="callout-inner">
<h3 class="callout-title">Keypoints<a class="anchor" aria-label="anchor" href="#keypoints1"></a>
</h3>
<div class="callout-content">
<ul><li>Dynamic branching creates multiple targets with a single
command</li>
<li>You usually need to write custom functions so that the output of the
branches includes necessary metadata</li>
<li>Parallel computing works at the level of the workflow, not the
function</li>
</ul></div>
</div>
</div>
<!-- 
Place links that you need to refer to multiple times across pages here. Delete
any links that you are not going to use. 
 -->
</div>
</section></div> <!-- / div.lesson-content -->
    </main><!-- / main#main-content.main-content --><nav class="bottom-pagination mx-md-4" aria-label="Previous and Next Chapter"><div class="d-block d-sm-block d-md-none">
        <a class="chapter-link" href="../instructor/files.html"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous</a>
        <a class="chapter-link float-end" href="../instructor/quarto.html">Next<i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
      <!-- content for large screens -->
      <div class="d-none d-sm-none d-md-block">
        <a class="chapter-link" href="../instructor/files.html" rel="prev"><i aria-hidden="true" class="small-arrow" data-feather="arrow-left"></i>Previous: Working with</a>
        <a class="chapter-link float-end" href="../instructor/quarto.html" rel="next">Next: Reproducible Reports... <i aria-hidden="true" class="small-arrow" data-feather="arrow-right"></i></a>
      </div>
    </nav></div> <!-- / div.primary-content.col-xs-12 -->
<!-- END:   inst/pkgdown/templates/content-instructor.html-->

      </div><!--/div.row-->
      		<footer class="row footer mx-md-3"><hr><div class="col-md-6">
				<p>This lesson is subject to the <a href="CODE_OF_CONDUCT.html">Code of Conduct</a></p>
        <p>
        
        <a href="https://github.com/joelnitta/targets-workshop/edit/main/episodes/batch.Rmd" class="external-link">Edit on GitHub</a>
        
	
        | <a href="https://github.com/joelnitta/targets-workshop/blob/main/CONTRIBUTING.md" class="external-link">Contributing</a> 
        | <a href="https://github.com/joelnitta/targets-workshop/" class="external-link">Source</a></p>
				<p><a href="https://github.com/joelnitta/targets-workshop/blob/main/CITATION" class="external-link">Cite</a> | <a href="mailto:joelnitta@gmail.com">Contact</a> | <a href="https://carpentries.org/about/" class="external-link">About</a></p>
			</div>
			<div class="col-md-6">
        
        <p>Materials licensed under <a href="../LICENSE.html">CC-BY 4.0</a> by the authors</p>
        
        <p><a href="https://creativecommons.org/licenses/by-sa/4.0/" class="external-link">Template licensed under CC-BY 4.0</a> by <a href="https://carpentries.org" class="external-link">The Carpentries</a></p>
        <p>Built with <a href="https://github.com/carpentries/sandpaper/tree/0.12.0" class="external-link">sandpaper (0.12.0)</a>,
        <a href="https://github.com/carpentries/pegboard" class="external-link">pegboard (0.5.3)</a>,
      and <a href="https://github.com/carpentries/varnish/tree/0.2.16" class="external-link">varnish (0.2.16)</a>.</p>
			</div>
		</footer></div> <!-- / div.container -->
	<div id="to-top">
		<a href="#top">
			<i class="search-icon" data-feather="arrow-up" role="img" aria-label="Back to top"></i><br><span class="d-none d-sm-none d-md-none d-lg-none d-xl-block">Back</span> To Top
		</a>
	</div>
  <script type="application/ld+json">
    {
  "@context": "https://schema.org",
  "@type": "TrainingMaterial",
  "@id": "https://joelnitta.github.io/targets-workshop/instructor/batch.html",
  "dct:conformsTo": "https://bioschemas.org/profiles/TrainingMaterial/1.0-RELEASE",
  "description": "A Carpentries Lesson teaching foundational data and coding skills to researchers worldwide",
  "keywords": "reproducibility, data, targets, R",
  "name": "Batch and Parallel Processing",
  "creativeWorkStatus": "active",
  "url": "https://joelnitta.github.io/targets-workshop/instructor/batch.html",
  "identifier": "https://joelnitta.github.io/targets-workshop/instructor/batch.html",
  "dateCreated": "2023-05-24",
  "dateModified": "2023-05-24",
  "datePublished": "2023-05-24"
}

  </script><script>
		feather.replace();
	</script><!-- Matomo
    2022-11-07: we have gotten a notification that we have an overage for our
    tracking and I'm pretty sure this has to do with Workbench usage.
    Considering that I am not _currently_ using this tracking because I do not
    yet know how to access the data, I am turning this off for now.
  <script>
    var _paq = window._paq = window._paq || [];
    /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
    _paq.push(["setDocumentTitle", document.domain + "/" + document.title]);
    _paq.push(["setDomains", ["*.preview.carpentries.org","*.datacarpentry.github.io","*.datacarpentry.org","*.librarycarpentry.github.io","*.librarycarpentry.org","*.swcarpentry.github.io", "*.carpentries.github.io"]]);
    _paq.push(["setDoNotTrack", true]);
    _paq.push(["disableCookies"]);
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
          var u="https://carpentries.matomo.cloud/";
          _paq.push(['setTrackerUrl', u+'matomo.php']);
          _paq.push(['setSiteId', '1']);
          var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
          g.async=true; g.src='https://cdn.matomo.cloud/carpentries.matomo.cloud/matomo.js'; s.parentNode.insertBefore(g,s);
        })();
  </script>
  End Matomo Code --></body></html><!-- END:   inst/pkgdown/templates/layout.html-->

