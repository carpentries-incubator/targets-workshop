---
title: 'Best Practices for targets Project Organization'
teaching: 10
exercises: 2
---

:::::::::::::::::::::::::::::::::::::: questions 

- What are best practices for organizing `targets` projects?
- How does the organization of a `targets` workflow differ from a script-based analysis?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Explain how to organize `targets` projects for maximal reproducibility
- Understand how to use functions in the context of `targets`

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: instructor

Episode summary: Demonstrate best-practices for project organization

:::::::::::::::::::::::::::::::::::::

```{r}
#| label: setup
#| echo: FALSE
#| message: FALSE
#| warning: FALSE

if (interactive()) {
  setwd("episodes")
}

library(targets)
library(tarchetypes)
source("files/lesson_functions.R")
```

## Organizing files and folders

So far, we have been doing everything with a single `_targets.R` file.
This is OK for a small workflow, but does not work very well when the workflow gets bigger.
There are better ways to organize your code.

First, let's create a directory called `R` to store R code *other than* `_targets.R` (remember, `_targets.R` must be placed in the overall project directory, not in a subdirectory).
Create a new R file in `R/` called `functions.R`.
This is where we will put our custom functions.
Let's go ahead and put `clean_penguin_data()` in there now and save it.

Similarly, let's put the `library()` calls in their own script in `R/` called `packages.R` (this isn't the only way to do it though; see the ["Managing Packages" episode](https://joelnitta.github.io/targets-workshop/packages.html) for alternative approaches).

We will also need to modify our `_targets.R` script to call these scripts with `source`:

```{r}
#| label = "tar-plan-show-2",
#| eval = FALSE,
#| code = readLines("files/plans/plan_2b.R")[2:9]
```

Now `_targets.R` is much more streamlined: it is focused just on the workflow and immediately tells us what happens in each step.

Finally, let's make some directories for storing data and output.
Within the main project directory, create two more directories, `data` and `results`.
(If you use version control, you will probably want to ignore the `data` and `results` directories, as they are not code).

## A word about functions

We mentioned custom functions earlier in the lesson, but this is an important topic that deserves further clarification.
If you are used to analyzing data in R with a series of scripts instead of a single workflow like `targets`, you may not write many functions (using the `function()` function).

This is a major difference from `targets`.
It would be quite difficult to write an efficient `targets` pipeline without the use of custom functions, because each target you build has to be the output of a single command.

We don't have time in this curriculum to cover how to write functions in R, but the [Software Carpentry lesson](https://swcarpentry.github.io/r-novice-gapminder/10-functions) is recommended for reviewing this topic.

Another major difference is that **each target must have a unique name**.
You may be used to writing code that looks like this:

```{r}
#| eval: FALSE
#| label: example-script

# Store a person's height in cm, then convert to inches
height <- 160
height <- height / 2.54
```

You would get an error if you tried to run the equivalent targets pipeline:

```{r}
#| eval: FALSE
#| label: example-bad-pipeline-show
#| echo: [-1, -2]
library(targets)
library(tarchetypes)
tar_plan(
    height = 160,
    height = height / 2.54
)
```

```{r}
#| echo: FALSE
#| label: example-bad-pipeline-hide
#| error: true
tar_dir({
  write_example_plan(chunk = "example-bad-pipeline-show")
  tar_make()
})
```

**A major part of working with `targets` pipelines is writing custom functions that are the right size.**
They should not be so small that each is just a single line of code; this would make your pipeline difficult to understand and be too difficult to maintain.
On the other hand, they should not be so big that each has large numbers of inputs and is thus overly sensitive to changes.

Striking this balance is more of art than science, and only comes with practice. I find a good rule of thumb is no more than three inputs per target.

::::::::::::::::::::::::::::::::::::: keypoints 

- Put code in the `R/` folder
- Put functions in `R/functions.R`
- Specify packages in `R/packages.R`
- Put data and results in their own directories
- Writing functions is a key skill for `targets` pipelines

::::::::::::::::::::::::::::::::::::::::::::::::

